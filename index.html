<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salivary Gland Diagnostic Support Tool v4.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, Arial, sans-serif; 
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1100px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 26px; margin-bottom: 5px; }
        .header p { font-size: 13px; opacity: 0.9; }
        .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            margin-top: 8px;
        }
        
        .main-disclaimer {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            margin: 0;
            font-weight: 600;
            text-align: center;
        }
        .main-disclaimer strong {
            display: block;
            font-size: 16px;
            margin-bottom: 8px;
            color: #dc3545;
        }
        
        .progress-bar { height: 6px; background: #e0e0e0; }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #1a365d 0%, #4a5568 100%); 
            transition: width 0.3s ease; 
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            padding: 15px;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
            gap: 5px;
        }
        .step-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #718096;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .step-dot.active {
            background: #1a365d;
            color: white;
        }
        .step-dot.completed {
            background: #38a169;
            color: white;
        }
        
        .content { padding: 40px; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        h3 { font-size: 20px; color: #1a365d; margin-bottom: 20px; font-weight: 600; }
        h4 { font-size: 16px; color: #2d3748; margin: 20px 0 12px 0; font-weight: 600; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            color: #2d3748; 
            font-weight: 500; 
            font-size: 14px; 
        }
        .form-group label .required { color: #e53e3e; }
        
        input[type="number"], input[type="text"], select, textarea { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #cbd5e0; 
            border-radius: 6px; 
            font-size: 14px; 
            font-family: inherit;
            transition: all 0.2s;
        }
        input[type="number"]:focus, input[type="text"]:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #1a365d; 
            box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1); 
        }
        textarea { resize: vertical; min-height: 80px; }
        
        .radio-group, .checkbox-group { margin-top: 10px; }
        .radio-group label, .checkbox-group label { 
            display: flex; 
            align-items: flex-start; 
            margin: 10px 0; 
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .radio-group label:hover, .checkbox-group label:hover {
            background: #f7fafc;
        }
        input[type="radio"], input[type="checkbox"] { 
            margin-right: 10px; 
            margin-top: 3px;
            flex-shrink: 0;
        }
        
        .info-box { 
            background: #ebf8ff; 
            border-left: 4px solid #3182ce; 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 0 6px 6px 0; 
            font-size: 13px; 
            color: #2c5282; 
        }
        .warning-box {
            background: #fffaf0;
            border-left: 4px solid #dd6b20;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 6px 6px 0;
            font-size: 13px;
            color: #c05621;
        }
        .critical-box { 
            background: #fff5f5; 
            border-left: 4px solid #c53030; 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 0 6px 6px 0;
            font-size: 13px; 
            color: #c53030; 
        }
        .success-box {
            background: #f0fff4;
            border-left: 4px solid #38a169;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 6px 6px 0;
            font-size: 13px;
            color: #276749;
        }
        
        .buttons { 
            display: flex; 
            gap: 12px; 
            margin-top: 40px; 
        }
        button { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%); 
            color: white; 
            flex: 1; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 20px rgba(26, 54, 93, 0.3); 
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary { 
            background: #e2e8f0; 
            color: #2d3748; 
        }
        .btn-secondary:hover {
            background: #cbd5e0;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 13px; 
            margin: 15px 0; 
        }
        th { 
            background: #f7fafc; 
            padding: 12px 10px; 
            text-align: left; 
            font-weight: 600; 
            border-bottom: 2px solid #1a365d;
            color: #1a365d;
        }
        td { 
            padding: 10px; 
            border-bottom: 1px solid #e2e8f0; 
        }
        tr:hover {
            background: #f7fafc;
        }
        
        /* Diagnosis Results */
        .diagnosis-card { 
            background: #f7fafc; 
            border: 1px solid #e2e8f0; 
            border-left: 5px solid #718096; 
            border-radius: 8px; 
            padding: 18px; 
            margin: 12px 0; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .diagnosis-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transform: translateX(4px);
        }
        .diagnosis-card.high { border-left-color: #38a169; background: #f0fff4; }
        .diagnosis-card.moderate { border-left-color: #dd6b20; background: #fffaf0; }
        .diagnosis-card.low { border-left-color: #e53e3e; background: #fff5f5; }
        .diagnosis-card.molecular { border-left-color: #805ad5; background: #faf5ff; }
        
        .diagnosis-card .header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .diagnosis-card .diagnosis-name {
            font-weight: 700;
            font-size: 15px;
            color: #1a365d;
        }
        .diagnosis-card .confidence-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .confidence-badge.high { background: #c6f6d5; color: #276749; }
        .confidence-badge.moderate { background: #feebc8; color: #c05621; }
        .confidence-badge.low { background: #fed7d7; color: #c53030; }
        .confidence-badge.molecular { background: #e9d8fd; color: #553c9a; }
        
        .diagnosis-card .score-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        .diagnosis-card .score-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .diagnosis-card.high .score-fill { background: #38a169; }
        .diagnosis-card.moderate .score-fill { background: #dd6b20; }
        .diagnosis-card.low .score-fill { background: #e53e3e; }
        .diagnosis-card.molecular .score-fill { background: #805ad5; }
        
        .diagnosis-card .rationale { 
            display: none; 
            font-size: 12px; 
            color: #4a5568; 
            margin-top: 12px; 
            padding-top: 12px;
            border-top: 1px dashed #cbd5e0;
        }
        .diagnosis-card.expanded .rationale { display: block; }
        .rationale-item {
            display: flex;
            align-items: flex-start;
            margin: 6px 0;
        }
        .rationale-item.positive::before {
            content: "‚úì";
            color: #38a169;
            font-weight: bold;
            margin-right: 8px;
        }
        .rationale-item.negative::before {
            content: "‚úó";
            color: #e53e3e;
            font-weight: bold;
            margin-right: 8px;
        }
        .rationale-item.neutral::before {
            content: "‚Ä¢";
            color: #718096;
            margin-right: 8px;
        }
        
        /* Grading Section */
        .grading-box {
            background: #faf5ff;
            border: 2px solid #805ad5;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .grading-box h4 {
            color: #553c9a;
            margin-top: 0;
        }
        .grade-result {
            font-size: 18px;
            font-weight: 700;
            color: #553c9a;
            margin: 10px 0;
        }
        
        /* Two column layout for IHC */
        .ihc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .ihc-section {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
        }
        .ihc-section h5 {
            color: #1a365d;
            font-size: 14px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .footer { 
            text-align: center; 
            font-size: 12px; 
            color: #718096; 
            margin-top: 30px; 
            padding: 20px;
            background: #f7fafc;
            border-top: 2px solid #e2e8f0; 
        }
        
        /* Report styles */
        .report-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .report-section:last-child {
            border-bottom: none;
        }
        .report-section h4 {
            color: #1a365d;
            font-size: 15px;
            margin-bottom: 12px;
        }
        
        /* Evidence quality indicators */
        .evidence-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }
        .evidence-tag.molecular { background: #805ad5; color: white; }
        .evidence-tag.morphology { background: #3182ce; color: white; }
        .evidence-tag.ihc { background: #38a169; color: white; }
        
        @media (max-width: 768px) {
            .content { padding: 20px; }
            .ihc-grid { grid-template-columns: 1fr; }
            .buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ Salivary Gland Diagnostic Support Tool</h1>
            <p style="font-size: 15px; font-weight: 600; margin: 12px 0; color: #e8f4f8;">
                Questo tool non fornisce diagnosi. Rende esplicito il ragionamento diagnostico.
            </p>
            <p style="font-size: 13px; opacity: 0.9;">Supporto decisionale per neoplasie epiteliali delle ghiandole salivari</p>
            <div class="version-badge">v4.1 | WHO Classification 2022 | Scoring ottimizzato</div>
        </div>
        
        <div class="main-disclaimer">
            <strong>‚ö†Ô∏è STRUMENTO DI SUPPORTO DECISIONALE</strong>
            Questo tool rende esplicito il ragionamento diagnostico basato sui dati inseriti. 
            Non fornisce diagnosi definitiva. La diagnosi finale richiede integrazione con morfologia HE completa, 
            pannello IHC, studi molecolari e correlazione clinico-radiologica. 
            La responsabilit√† diagnostica rimane del patologo.
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="step-indicator" id="stepIndicator"></div>
        
        <div class="content" id="mainContent"></div>
        
        <div class="footer">
            <p><strong>Salivary Gland Diagnostic Support Tool v4.1</strong></p>
            <p>Basato su WHO Classification of Head and Neck Tumours, 5th Edition (2022)</p>
            <p>Per uso didattico e di orientamento diagnostico | ¬© 2026</p>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        let currentStep = 1;
        const totalSteps = 9;
        let formData = {};

        // ========== TUMOR DATABASE WITH SCORING WEIGHTS (v4.1 - UPDATED) ==========
        const tumorDatabase = {
            PA: {
                name: "Adenoma Pleomorfo",
                fullName: "Adenoma Pleomorfo (Mixed Tumor)",
                behavior: "Benigno",
                weights: {
                    pattern: { pleomorphic: 5, basaloid: -2, cribriform: -3 },
                    pni: { no: 3, yes: -5 },
                    necrosis: { no: 2, yes: -3 },
                    cytology: { low: 2, high: -2 },
                    ki67: { low: 2, borderline: 0, high: -1, veryHigh: -2 }, // MODIFICATO: pesi ridotti
                    myoepithelial: { 
                        intact: 4,
                        partialPA: 2,
                        indeterminate: 0,
                        partialACC: -2,
                        lost: -4
                    }, // MODIFICATO: 5 livelli
                    lef1: { pos: 5, neg: -3 },
                    plag1: { pos: 5, neg: 0 },
                    hmga2: { pos: 4, neg: 0 },
                    myb: { pos: -5, neg: 2 }
                }
            },
            ACC: {
                name: "Carcinoma Adenoidocistico",
                fullName: "Adenoid Cystic Carcinoma (ACC)",
                behavior: "Maligno",
                hasGrading: true,
                weights: {
                    pattern: { basaloid: 4, cribriform: 5, pleomorphic: -3 },
                    pni: { no: -2, yes: 5 },
                    necrosis: { no: 0, yes: 2 },
                    cytology: { low: 0, high: 2 },
                    ki67: { low: -1, borderline: 0, high: 1, veryHigh: 2 }, // MODIFICATO: pesi ridotti
                    myoepithelial: { 
                        intact: -4,
                        partialPA: -2,
                        indeterminate: 0,
                        partialACC: 2,
                        lost: 4
                    }, // MODIFICATO: 5 livelli
                    lef1: { pos: -5, neg: 3 },
                    cd117: { pos: 3, neg: -1 },
                    sox10: { pos: 3, neg: -2 },
                    myb: { pos: 5, neg: -1 }
                }
            },
            MEC: {
                name: "Carcinoma Mucoepidermoide",
                fullName: "Mucoepidermoid Carcinoma (MEC)",
                behavior: "Maligno (grado-dipendente)",
                hasGrading: true,
                weights: {
                    pattern: { mucoepidermoid: 6, squamous: 3 }, // AUMENTATO: +1 per pattern, +1 per squamous
                    mucousCells: { abundant: 4, scarce: -1 }, // AUMENTATO: +3 ‚Üí +4 (cellule mucose patognomoniche)
                    cysticComponent: { prominent: 2, minimal: 0 },
                    necrosis: { no: 0, yes: 2 },
                    pni: { no: 0, yes: 3 },
                    ki67: { low: 0, borderline: 0, high: 1, veryHigh: 2 },
                    maml2: { pos: 5, neg: 0 },
                    p63: { pos: 3, neg: -1 }, // AUMENTATO: +2 ‚Üí +3
                    ck5_6: { pos: 4, neg: -1 } // AUMENTATO: +3 ‚Üí +4
                }
            },
            AciCC: {
                name: "Carcinoma a Cellule Acinari",
                fullName: "Acinic Cell Carcinoma (AciCC)",
                behavior: "Maligno (basso grado)",
                weights: {
                    pattern: { acinic: 5 },
                    zymogenGranules: { present: 4, absent: -2 },
                    dog1: { pos: 4, neg: -2 },
                    sox10: { pos: 3, neg: 0 },
                    mammaglobin: { pos: 3, neg: 0 },
                    nr4a3: { pos: 6, neg: 0 },
                    s100: { pos: 2, neg: 0 }
                }
            },
            MASC: {
                name: "MASC",
                fullName: "Mammary Analogue Secretory Carcinoma",
                behavior: "Maligno (basso grado)",
                weights: {
                    pattern: { acinic: 2, papillary: 3 },
                    dog1: { pos: 3, neg: 0 },
                    mammaglobin: { pos: 4, neg: -1 },
                    s100: { pos: 3, neg: -1 },
                    etv6: { pos: 7, neg: 0 },
                    pantrk: { pos: 4, neg: 0 }
                }
            },
            SDC: {
                name: "Carcinoma Duttale Salivare",
                fullName: "Salivary Duct Carcinoma (SDC)",
                behavior: "Maligno (alto grado)",
                weights: {
                    pattern: { ductal: 5, apocrine: 4 },
                    cytology: { high: 3 },
                    necrosis: { yes: 2 },
                    ki67: { low: 0, borderline: 0, high: 1, veryHigh: 2 }, // MODIFICATO: pesi ridotti
                    ar: { pos: 5, neg: -2 },
                    her2: { pos: 4, amplified: 5, neg: 0 },
                    gcdfp15: { pos: 3, neg: 0 },
                    ck7: { pos: 2, neg: -1 }
                }
            },
            Warthin: {
                name: "Tumore di Warthin",
                fullName: "Warthin Tumor (Cystadenolymphoma)",
                behavior: "Benigno",
                weights: {
                    pattern: { oncocytic: 3, papillary: 3 },
                    lymphoidStroma: { present: 5, absent: -5 },
                    bilaterality: { yes: 2, no: 0 },
                    gland: { parotid: 3, other: -3 },
                    smoking: { yes: 2, no: 0 }
                }
            },
            CaExPA: {
                name: "Carcinoma ex-Adenoma Pleomorfo",
                fullName: "Carcinoma ex Pleomorphic Adenoma",
                behavior: "Maligno",
                hasInvasionGrading: true,
                weights: {
                    priorPA: { yes: 5, no: -3 },
                    longHistory: { yes: 3, no: 0 },
                    rapidGrowth: { yes: 3, no: 0 },
                    residualPA: { present: 4, absent: 0 },
                    highGradeComponent: { present: 3, absent: 0 },
                    plag1: { pos: 3, neg: 0 },
                    hmga2: { pos: 3, neg: 0 }
                }
            }
        };

        // ========== GRADING SYSTEMS ==========
        const gradingSystems = {
            ACC: {
                name: "ACC Grading (WHO 2022)",
                calculateGrade: function(solidPct) {
                    if (solidPct < 30) return { grade: "I", description: "Tubulare/Cribriforme", prognosis: "Migliore" };
                    if (solidPct <= 70) return { grade: "II", description: "Misto", prognosis: "Intermedia" };
                    return { grade: "III", description: "Solido (>70%)", prognosis: "Peggiore" };
                }
            },
            MEC: {
                name: "MEC Grading (AFIP/Brandwein)",
                parameters: [
                    { id: "mec_cystic", label: "Componente cistica <20%", points: 2 },
                    { id: "mec_neural", label: "Invasione perineurale", points: 2 },
                    { id: "mec_necrosis", label: "Necrosi", points: 3 },
                    { id: "mec_mitoses", label: "‚â•4 mitosi/10 HPF", points: 3 },
                    { id: "mec_anaplasia", label: "Anaplasia", points: 4 }
                ],
                calculateGrade: function(totalPoints) {
                    if (totalPoints <= 4) return { grade: "Low", description: "Basso grado (0-4 punti)", prognosis: "Eccellente" };
                    if (totalPoints <= 6) return { grade: "Intermediate", description: "Grado intermedio (5-6 punti)", prognosis: "Intermedia" };
                    return { grade: "High", description: "Alto grado (‚â•7 punti)", prognosis: "Sfavorevole" };
                }
            },
            CaExPA: {
                name: "Ca ex-PA Invasion (WHO 2022)",
                calculateGrade: function(invasionMm) {
                    if (invasionMm <= 1.5) return { 
                        grade: "Minimamente Invasivo", 
                        description: "Invasione ‚â§1.5mm oltre la capsula",
                        prognosis: "Eccellente (simile a PA)"
                    };
                    if (invasionMm <= 4) return { 
                        grade: "Invasivo", 
                        description: "Invasione 1.5-4mm",
                        prognosis: "Intermedia"
                    };
                    return { 
                        grade: "Ampiamente Invasivo", 
                        description: "Invasione >4mm",
                        prognosis: "Riservata"
                    };
                }
            }
        };

        // ========== PATTERN DEFINITIONS ==========
        const patterns = {
            basaloid: { 
                name: "Basaloide", 
                description: "Cellule basali uniformi, nuclei ipercromici, poco citoplasma",
                suggestive: ["ACC", "Basaloid SCC", "BCA"]
            },
            cribriform: { 
                name: "Cribriforme", 
                description: "Pseudocisti con materiale ialino/basofilo PAS+",
                suggestive: ["ACC"]
            },
            acinic: { 
                name: "Acinare", 
                description: "Cellule sierose con granuli zimogeni basofili",
                suggestive: ["AciCC", "MASC"]
            },
            oncocytic: { 
                name: "Oncocitario", 
                description: "Cellule eosinofile granulari ricche di mitocondri",
                suggestive: ["Warthin", "Oncocitoma", "Oncocytic Ca"]
            },
            mucoepidermoid: { 
                name: "Mucoepidermoide", 
                description: "Mix di cellule mucose, intermedie e squamoidi",
                suggestive: ["MEC"]
            },
            pleomorphic: { 
                name: "Pleomorfo/Bifasico", 
                description: "Componente epiteliale + stroma mixoide/condroide",
                suggestive: ["PA", "CaExPA"]
            },
            clear_cell: { 
                name: "Cellule Chiare", 
                description: "Citoplasma otticamente vuoto (glicogeno)",
                suggestive: ["HCCC", "EMC", "MEC"]
            },
            papillary: { 
                name: "Papillare", 
                description: "Strutture papillari con assi fibrovascolari",
                suggestive: ["MASC", "Warthin", "Cystadenocarcinoma"]
            },
            ductal: { 
                name: "Duttale/Apocrino", 
                description: "Strutture duttali, aspetto apocrino, comedonecrosi",
                suggestive: ["SDC"]
            },
            solid: {
                name: "Solido",
                description: "Nidi solidi senza pattern specifico",
                suggestive: ["Multiple entities"]
            }
        };

        // ========== NAVIGATION ==========
        function updateProgress() {
            const percentage = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            
            let indicatorHTML = '';
            for (let i = 1; i <= totalSteps; i++) {
                let className = 'step-dot';
                if (i < currentStep) className += ' completed';
                else if (i === currentStep) className += ' active';
                indicatorHTML += `<div class="${className}">${i}</div>`;
            }
            document.getElementById('stepIndicator').innerHTML = indicatorHTML;
        }

        function nextStep() {
            saveData();
            if (validateStep()) {
                currentStep++;
                if (currentStep > totalSteps) currentStep = totalSteps;
                render();
                window.scrollTo(0, 0);
            }
        }

        function prevStep() {
            saveData();
            currentStep--;
            if (currentStep < 1) currentStep = 1;
            render();
            window.scrollTo(0, 0);
        }

        function goToStep(step) {
            saveData();
            currentStep = step;
            render();
            window.scrollTo(0, 0);
        }

        // ========== VALIDATION ==========
        function validateStep() {
            if (currentStep === 1) {
                const specimenType = document.querySelector('input[name="specimenType"]:checked');
                const gland = document.getElementById('gland')?.value;
                if (!specimenType || !gland) {
                    alert('‚ö†Ô∏è Compila i campi obbligatori:\n- Tipo campione\n- Ghiandola');
                    return false;
                }
            }
            if (currentStep === 3) {
                const pattern = document.querySelector('input[name="pattern"]:checked');
                if (!pattern) {
                    alert('‚ö†Ô∏è Seleziona almeno un pattern morfologico');
                    return false;
                }
            }
            return true;
        }

        // ========== DATA MANAGEMENT ==========
        function saveData() {
            // Step 1: Clinical context
            const specimenType = document.querySelector('input[name="specimenType"]:checked')?.value;
            const gland = document.getElementById('gland')?.value;
            const location = document.getElementById('location')?.value;
            const priorPA = document.querySelector('input[name="priorPA"]:checked')?.value;
            const longHistory = document.querySelector('input[name="longHistory"]:checked')?.value;
            const rapidGrowth = document.querySelector('input[name="rapidGrowth"]:checked')?.value;
            
            // Step 2: Malignancy criteria
            const pni = document.querySelector('input[name="pni"]:checked')?.value;
            const cytology = document.querySelector('input[name="cytology"]:checked')?.value;
            const necrosis = document.querySelector('input[name="necrosis"]:checked')?.value;
            const mitoses = document.getElementById('mitoses')?.value;
            
            // Step 3: Pattern
            const pattern = document.querySelector('input[name="pattern"]:checked')?.value;
            const secondaryPattern = document.querySelector('input[name="secondaryPattern"]:checked')?.value;
            const solidPercentage = document.getElementById('solidPercentage')?.value;
            const lymphoidStroma = document.querySelector('input[name="lymphoidStroma"]:checked')?.value;
            const residualPA = document.querySelector('input[name="residualPA"]:checked')?.value;
            
            // Step 4: Base IHC
            const ihcMarkers = ['p63', 'sma', 'calponin', 'ck7', 's100', 'dog1', 'sox10'];
            ihcMarkers.forEach(marker => {
                const value = document.querySelector(`input[name="${marker}"]:checked`)?.value;
                if (value) formData[marker] = value;
            });
            const ki67 = document.getElementById('ki67')?.value;
            
            // Step 5: Discriminant IHC
            const discMarkers = ['lef1', 'cd117', 'bcl2', 'ar', 'her2', 'gcdfp15', 'mammaglobin', 'ck5_6', 'pantrk'];
            discMarkers.forEach(marker => {
                const value = document.querySelector(`input[name="${marker}"]:checked`)?.value;
                if (value) formData[marker] = value;
            });
            
            // Step 6: Molecular
            const molMarkers = ['myb', 'plag1', 'hmga2', 'nr4a3', 'etv6', 'maml2'];
            molMarkers.forEach(marker => {
                const value = document.querySelector(`input[name="${marker}"]:checked`)?.value;
                if (value) formData[marker] = value;
            });
            
            // Step 7: Grading
            const mecParams = gradingSystems.MEC.parameters;
            mecParams.forEach(p => {
                const value = document.querySelector(`input[name="${p.id}"]:checked`)?.value;
                if (value) formData[p.id] = value;
            });
            const invasionMm = document.getElementById('invasionMm')?.value;
            
            // Step 8: Clinical
            const clinicalSuspicion = document.getElementById('clinicalSuspicion')?.value;
            const clinicalNotes = document.getElementById('clinicalNotes')?.value;
            
            // Save all
            if (specimenType) formData.specimenType = specimenType;
            if (gland) formData.gland = gland;
            if (location) formData.location = location;
            if (priorPA) formData.priorPA = priorPA;
            if (longHistory) formData.longHistory = longHistory;
            if (rapidGrowth) formData.rapidGrowth = rapidGrowth;
            if (pni) formData.pni = pni;
            if (cytology) formData.cytology = cytology;
            if (necrosis) formData.necrosis = necrosis;
            if (mitoses) formData.mitoses = mitoses;
            if (pattern) formData.pattern = pattern;
            if (secondaryPattern) formData.secondaryPattern = secondaryPattern;
            if (solidPercentage) formData.solidPercentage = solidPercentage;
            if (lymphoidStroma) formData.lymphoidStroma = lymphoidStroma;
            if (residualPA) formData.residualPA = residualPA;
            if (ki67) formData.ki67 = ki67;
            if (invasionMm) formData.invasionMm = invasionMm;
            if (clinicalSuspicion) formData.clinicalSuspicion = clinicalSuspicion;
            if (clinicalNotes) formData.clinicalNotes = clinicalNotes;
        }

        // ========== SCORING ALGORITHM (v4.1 - UPDATED) ==========
        function calculateAllScores() {
            const scores = {};
            const rationales = {};
            
            for (const [tumorKey, tumor] of Object.entries(tumorDatabase)) {
                scores[tumorKey] = 0;
                rationales[tumorKey] = [];
                
                const weights = tumor.weights;
                
                // Pattern scoring
                if (weights.pattern && formData.pattern) {
                    const patternWeight = weights.pattern[formData.pattern];
                    if (patternWeight) {
                        scores[tumorKey] += patternWeight;
                        const sign = patternWeight > 0 ? 'positive' : 'negative';
                        rationales[tumorKey].push({
                            text: `Pattern ${patterns[formData.pattern]?.name || formData.pattern}`,
                            type: sign,
                            tag: 'morphology'
                        });
                    }
                }
                
                // PNI
                if (weights.pni && formData.pni) {
                    const pniWeight = weights.pni[formData.pni];
                    if (pniWeight) {
                        scores[tumorKey] += pniWeight;
                        rationales[tumorKey].push({
                            text: `Infiltrazione perineurale: ${formData.pni === 'yes' ? 'presente' : 'assente'}`,
                            type: pniWeight > 0 ? 'positive' : (pniWeight < 0 ? 'negative' : 'neutral'),
                            tag: 'morphology'
                        });
                    }
                }
                
                // Necrosis
                if (weights.necrosis && formData.necrosis) {
                    const necWeight = weights.necrosis[formData.necrosis];
                    if (necWeight) {
                        scores[tumorKey] += necWeight;
                        if (necWeight !== 0) {
                            rationales[tumorKey].push({
                                text: `Necrosi: ${formData.necrosis === 'yes' ? 'presente' : 'assente'}`,
                                type: necWeight > 0 ? 'positive' : 'negative',
                                tag: 'morphology'
                            });
                        }
                    }
                }
                
                // Cytology
                if (weights.cytology && formData.cytology) {
                    const cytoWeight = weights.cytology[formData.cytology];
                    if (cytoWeight) {
                        scores[tumorKey] += cytoWeight;
                        rationales[tumorKey].push({
                            text: `Atipia citologica: ${formData.cytology === 'high' ? 'alta' : 'bassa'}`,
                            type: cytoWeight > 0 ? 'positive' : 'negative',
                            tag: 'morphology'
                        });
                    }
                }
                
                // Ki-67 (MODIFICATO v4.1 - nuovi cut-off e warning)
                if (weights.ki67 && formData.ki67) {
                    const ki67Val = parseFloat(formData.ki67);
                    let ki67Category;
                    let ki67Text;
                    
                    if (ki67Val <= 10) {
                        ki67Category = 'low';
                        ki67Text = 'compatibile con benignit√†';
                    } else if (ki67Val <= 20) {
                        ki67Category = 'borderline';
                        ki67Text = 'zona grigia, non discriminante';
                    } else if (ki67Val <= 30) {
                        ki67Category = 'high';
                        ki67Text = 'suggestivo malignit√†';
                    } else {
                        ki67Category = 'veryHigh';
                        ki67Text = 'alto indice proliferativo';
                    }
                    
                    const ki67Weight = weights.ki67[ki67Category];
                    if (ki67Weight && ki67Weight !== 0) {
                        scores[tumorKey] += ki67Weight;
                        rationales[tumorKey].push({
                            text: `Ki-67: ${formData.ki67}% (${ki67Text}) ‚ö†Ô∏è parametro instabile`,
                            type: ki67Weight > 0 ? 'positive' : (ki67Weight < 0 ? 'negative' : 'neutral'),
                            tag: 'ihc'
                        });
                    }
                }
                
                // Myoepithelial status (MODIFICATO v4.1 - sistema a 5 livelli)
                if (weights.myoepithelial) {
                    const p63 = formData.p63;
                    const sma = formData.sma;
                    const calponin = formData.calponin;
                    
                    let myoStatus;
                    let statusText;
                    
                    // Logica a 5 livelli
                    const posCount = [p63, sma, calponin].filter(m => m === 'pos').length;
                    const focalCount = [p63, sma, calponin].filter(m => m === 'focal').length;
                    const negCount = [p63, sma, calponin].filter(m => m === 'neg').length;
                    
                    if (posCount === 3 || (posCount === 2 && focalCount === 1)) {
                        // Tutti diffusamente positivi o quasi
                        myoStatus = 'intact';
                        statusText = 'conservato (3/3 o 2/3 diffusi)';
                    } else if ((posCount + focalCount >= 2) && p63 !== 'neg') {
                        // Almeno 2 marker presenti, p63 non completamente perso
                        myoStatus = 'partialPA';
                        statusText = 'parziale, pattern PA-like';
                    } else if (negCount === 3) {
                        // Tutti negativi
                        myoStatus = 'lost';
                        statusText = 'completamente perso';
                    } else if (p63 === 'neg' || (p63 === 'focal' && sma === 'neg')) {
                        // p63 perso/scarso, possibile ACC
                        myoStatus = 'partialACC';
                        statusText = 'parziale, pattern ACC-like (p63 scarso)';
                    } else {
                        // Pattern non classificabile
                        myoStatus = 'indeterminate';
                        statusText = 'indeterminato/discordante';
                    }
                    
                    const myoWeight = weights.myoepithelial[myoStatus];
                    if (myoWeight !== undefined) {
                        scores[tumorKey] += myoWeight;
                        rationales[tumorKey].push({
                            text: `Mantello mioepiteliale: ${statusText}`,
                            type: myoWeight > 0 ? 'positive' : (myoWeight < 0 ? 'negative' : 'neutral'),
                            tag: 'ihc'
                        });
                    }
                }
                
                // IHC markers
                const ihcMarkersToCheck = ['lef1', 'cd117', 'sox10', 'dog1', 'ar', 'her2', 
                                          'gcdfp15', 'mammaglobin', 'p63', 'ck5_6', 'pantrk'];
                ihcMarkersToCheck.forEach(marker => {
                    if (weights[marker] && formData[marker]) {
                        const markerWeight = weights[marker][formData[marker]];
                        if (markerWeight && markerWeight !== 0) {
                            scores[tumorKey] += markerWeight;
                            rationales[tumorKey].push({
                                text: `${marker.toUpperCase()}: ${formData[marker] === 'pos' ? 'positivo' : (formData[marker] === 'amplified' ? 'amplificato' : 'negativo')}`,
                                type: markerWeight > 0 ? 'positive' : 'negative',
                                tag: 'ihc'
                            });
                        }
                    }
                });
                
                // Molecular markers (high weight)
                const molMarkersToCheck = ['myb', 'plag1', 'hmga2', 'nr4a3', 'etv6', 'maml2'];
                molMarkersToCheck.forEach(marker => {
                    if (weights[marker] && formData[marker] === 'pos') {
                        const markerWeight = weights[marker]['pos'];
                        if (markerWeight && markerWeight > 0) {
                            scores[tumorKey] += markerWeight;
                            rationales[tumorKey].push({
                                text: `${marker.toUpperCase()} FISH: POSITIVO`,
                                type: 'positive',
                                tag: 'molecular'
                            });
                        }
                    }
                });
                
                // Special: Lymphoid stroma for Warthin
                if (tumorKey === 'Warthin' && formData.lymphoidStroma) {
                    const lymphWeight = weights.lymphoidStroma?.[formData.lymphoidStroma === 'yes' ? 'present' : 'absent'];
                    if (lymphWeight) {
                        scores[tumorKey] += lymphWeight;
                        rationales[tumorKey].push({
                            text: `Stroma linfoide: ${formData.lymphoidStroma === 'yes' ? 'presente' : 'assente'}`,
                            type: lymphWeight > 0 ? 'positive' : 'negative',
                            tag: 'morphology'
                        });
                    }
                }
                
                // Special: Prior PA history for CaExPA
                if (tumorKey === 'CaExPA') {
                    if (formData.priorPA === 'yes') {
                        scores[tumorKey] += 5;
                        rationales[tumorKey].push({
                            text: 'Storia di adenoma pleomorfo pregresso',
                            type: 'positive',
                            tag: 'morphology'
                        });
                    }
                    if (formData.residualPA === 'yes') {
                        scores[tumorKey] += 4;
                        rationales[tumorKey].push({
                            text: 'Componente PA residua identificata',
                            type: 'positive',
                            tag: 'morphology'
                        });
                    }
                    if (formData.longHistory === 'yes') {
                        scores[tumorKey] += 3;
                        rationales[tumorKey].push({
                            text: 'Lunga storia clinica (>10 anni)',
                            type: 'positive',
                            tag: 'morphology'
                        });
                    }
                    if (formData.rapidGrowth === 'yes') {
                        scores[tumorKey] += 3;
                        rationales[tumorKey].push({
                            text: 'Crescita rapida recente',
                            type: 'positive',
                            tag: 'morphology'
                        });
                    }
                }
                
                // Gland specificity
                if (tumorKey === 'Warthin' && formData.gland === 'parotid') {
                    scores[tumorKey] += 3;
                    rationales[tumorKey].push({
                        text: 'Localizzazione parotidea (tipica)',
                        type: 'positive',
                        tag: 'morphology'
                    });
                }
                
                // NUOVO v4.1: PENALTY per Ca ex-PA in trucut
                if (tumorKey === 'CaExPA' && formData.specimenType === 'trucut') {
                    const originalScore = scores[tumorKey];
                    scores[tumorKey] = Math.round(scores[tumorKey] * 0.6); // Riduzione 40%
                    
                    rationales[tumorKey].push({
                        text: `‚ö†Ô∏è Trucut: score ridotto da ${originalScore} a ${scores[tumorKey]} (diagnosi definitiva richiede pezzo operatorio)`,
                        type: 'neutral',
                        tag: 'morphology'
                    });
                }
            }
            
            return { scores, rationales };
        }

        function computeResults() {
            const { scores, rationales } = calculateAllScores();
            
            // Normalize and rank
            const maxScore = Math.max(...Object.values(scores), 1);
            const results = [];
            
            // NUOVO v4.1: Classificazione marker molecolari
            const pathognomonicMarkers = {
                'ETV6-NTRK3': 'MASC',     // Patognomonico
                'MYB-NFIB': 'ACC',        // Virtualmente patognomonico (~80%)
                'NR4A3': 'AciCC'          // Altamente specifico
            };
            
            const supportiveMarkers = {
                'PLAG1': 'PA',            // Supportivo (~70%)
                'HMGA2': 'PA',            // Supportivo (~30%)
                'MAML2': 'MEC'            // Supportivo (~50-70%, prognostico)
            };
            
            for (const [tumorKey, score] of Object.entries(scores)) {
                const tumor = tumorDatabase[tumorKey];
                const normalizedScore = Math.max(0, score);
                const percentage = Math.round((normalizedScore / maxScore) * 100);
                
                // Determine confidence
                let confidence = 'low';
                if (normalizedScore >= 12) confidence = 'high';
                else if (normalizedScore >= 6) confidence = 'moderate';
                
                // Check for molecular confirmation - SISTEMA A 2 TIER
                const hasPathognomonicMarker = 
                    (tumorKey === 'MASC' && formData.etv6 === 'pos') ||
                    (tumorKey === 'ACC' && formData.myb === 'pos') ||
                    (tumorKey === 'AciCC' && formData.nr4a3 === 'pos');
                
                const hasSupportiveMarker = 
                    (tumorKey === 'PA' && (formData.plag1 === 'pos' || formData.hmga2 === 'pos')) ||
                    (tumorKey === 'MEC' && formData.maml2 === 'pos') ||
                    (tumorKey === 'CaExPA' && (formData.plag1 === 'pos' || formData.hmga2 === 'pos'));
                
                // TIER 1: Marker patognomonico ‚Üí MOLECULAR anche con score basso
                if (hasPathognomonicMarker && normalizedScore >= 5) {
                    confidence = 'molecular';
                }
                // TIER 2: Marker supportivo ‚Üí MOLECULAR solo se score morfologico solido
                else if (hasSupportiveMarker && normalizedScore >= 10) {
                    confidence = 'molecular';
                }
                
                // Add grading if applicable
                let grading = null;
                if (tumorKey === 'ACC' && formData.solidPercentage) {
                    grading = gradingSystems.ACC.calculateGrade(parseFloat(formData.solidPercentage));
                }
                if (tumorKey === 'MEC') {
                    let mecPoints = 0;
                    gradingSystems.MEC.parameters.forEach(p => {
                        if (formData[p.id] === 'yes') mecPoints += p.points;
                    });
                    if (mecPoints > 0 || formData.pattern === 'mucoepidermoid') {
                        grading = gradingSystems.MEC.calculateGrade(mecPoints);
                    }
                }
                if (tumorKey === 'CaExPA' && formData.invasionMm) {
                    grading = gradingSystems.CaExPA.calculateGrade(parseFloat(formData.invasionMm));
                }
                
                results.push({
                    key: tumorKey,
                    name: tumor.name,
                    fullName: tumor.fullName,
                    behavior: tumor.behavior,
                    score: normalizedScore,
                    percentage: percentage,
                    confidence: confidence,
                    rationale: rationales[tumorKey] || [],
                    grading: grading
                });
            }
            
            // Sort by score descending
            results.sort((a, b) => b.score - a.score);
            
            // NUOVO v4.1: Detect close scores (differenza <3 tra top 2)
            let closeScoresWarning = null;
            if (results.length >= 2 && results[0].score > 0) {
                const scoreDiff = results[0].score - results[1].score;
                if (scoreDiff > 0 && scoreDiff < 3) {
                    closeScoresWarning = {
                        diff: scoreDiff,
                        top1: results[0].name,
                        top2: results[1].name
                    };
                }
            }
            
            // Aggiungi al primo risultato
            if (closeScoresWarning) {
                results[0].closeScoresWarning = closeScoresWarning;
            }
            
            // Filter out very low scores
            return results.filter(r => r.score > 0 || r.confidence === 'molecular');
        }

        // ========== REPORT GENERATION ==========
        function generateTextReport() {
            const results = computeResults();
            const date = new Date().toLocaleDateString('it-IT');
            const time = new Date().toLocaleTimeString('it-IT');
            
            let report = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            report += `      SALIVARY GLAND DIAGNOSTIC SUPPORT - REPORT\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            report += `Data: ${date} ${time}\n`;
            report += `Tool Version: 4.1 (WHO 2022 - Scoring ottimizzato)\n\n`;
            
            report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            report += `DATI CLINICI\n`;
            report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            report += `Campione: ${formData.specimenType || 'N/D'}\n`;
            report += `Ghiandola: ${formData.gland || 'N/D'}\n`;
            report += `Localizzazione: ${formData.location || 'N/D'}\n`;
            if (formData.priorPA === 'yes') report += `‚ö†Ô∏è Storia di PA pregresso: S√å\n`;
            report += `\n`;
            
            report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            report += `PARAMETRI MORFOLOGICI\n`;
            report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            report += `Pattern principale: ${formData.pattern ? patterns[formData.pattern]?.name : 'N/D'}\n`;
            report += `Componente solida: ${formData.solidPercentage || 'N/D'}%\n`;
            report += `Infiltrazione perineurale: ${formData.pni === 'yes' ? 'PRESENTE ‚ö†Ô∏è' : (formData.pni === 'no' ? 'Assente' : 'N/D')}\n`;
            report += `Atipia citologica: ${formData.cytology || 'N/D'}\n`;
            report += `Necrosi: ${formData.necrosis || 'N/D'}\n`;
            report += `\n`;
            
            report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            report += `IMMUNOISTOCHIMICA\n`;
            report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            report += `Ki-67: ${formData.ki67 || 'N/D'}%\n`;
            report += `p63: ${formData.p63 || 'N/D'} | SMA: ${formData.sma || 'N/D'} | Calponina: ${formData.calponin || 'N/D'}\n`;
            report += `LEF1: ${formData.lef1 || 'N/D'} | SOX10: ${formData.sox10 || 'N/D'} | CD117: ${formData.cd117 || 'N/D'}\n`;
            report += `DOG1: ${formData.dog1 || 'N/D'} | Mammaglobina: ${formData.mammaglobin || 'N/D'}\n`;
            if (formData.ar || formData.her2) {
                report += `AR: ${formData.ar || 'N/D'} | HER2: ${formData.her2 || 'N/D'}\n`;
            }
            report += `\n`;
            
            report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            report += `STUDI MOLECOLARI (FISH/NGS)\n`;
            report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
            report += `MYB-NFIB: ${formData.myb || 'N/D'}\n`;
            report += `PLAG1: ${formData.plag1 || 'N/D'} | HMGA2: ${formData.hmga2 || 'N/D'}\n`;
            report += `NR4A3: ${formData.nr4a3 || 'N/D'} | ETV6-NTRK3: ${formData.etv6 || 'N/D'}\n`;
            report += `MAML2: ${formData.maml2 || 'N/D'}\n`;
            report += `\n`;
            
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            report += `DIAGNOSI DIFFERENZIALE (ranking per score)\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            
            results.slice(0, 5).forEach((r, i) => {
                report += `${i + 1}. ${r.fullName}\n`;
                report += `   Score: ${r.score} | Confidenza: ${r.confidence.toUpperCase()}\n`;
                report += `   Comportamento: ${r.behavior}\n`;
                if (r.grading) {
                    report += `   GRADING: ${r.grading.grade} - ${r.grading.description}\n`;
                    report += `   Prognosi: ${r.grading.prognosis}\n`;
                }
                report += `   Criteri:\n`;
                r.rationale.slice(0, 5).forEach(rat => {
                    const symbol = rat.type === 'positive' ? '‚úì' : (rat.type === 'negative' ? '‚úó' : '‚Ä¢');
                    report += `     ${symbol} ${rat.text}\n`;
                });
                report += `\n`;
            });
            
            if (formData.clinicalSuspicion) {
                report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                report += `CORRELAZIONE CON SOSPETTO CLINICO\n`;
                report += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                report += `Sospetto: ${formData.clinicalSuspicion}\n`;
            }
            
            if (formData.clinicalNotes) {
                report += `\nNote cliniche: ${formData.clinicalNotes}\n`;
            }
            
            report += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            report += `DISCLAIMER\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            report += `Questo report √® generato da uno strumento di SUPPORTO diagnostico.\n`;
            report += `NON costituisce diagnosi definitiva.\n`;
            report += `La diagnosi finale richiede integrazione con morfologia completa,\n`;
            report += `pannello IHC, studi molecolari e correlazione clinico-radiologica.\n`;
            report += `La responsabilit√† diagnostica rimane del patologo.\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            
            return report;
        }

        function downloadTextReport() {
            const report = generateTextReport();
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `salivary_gland_report_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ========== RENDERING ==========
        function render() {
            let html = '';
            
            // ==================== STEP 1: Clinical Context ====================
            if (currentStep === 1) {
                html = `
                    <div class="step active">
                        <h3>Step 1/${totalSteps}: Contesto Clinico</h3>
                        
                        <div class="form-group">
                            <label>Tipo di campione <span class="required">*</span></label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="specimenType" value="trucut" 
                                           ${formData.specimenType === 'trucut' ? 'checked' : ''}>
                                    <div>
                                        <strong>Trucut / Core biopsy</strong><br>
                                        <small style="color: #718096;">Margini non valutabili, possibile sampling error</small>
                                    </div>
                                </label>
                                <label>
                                    <input type="radio" name="specimenType" value="surgical" 
                                           ${formData.specimenType === 'surgical' ? 'checked' : ''}>
                                    <div>
                                        <strong>Pezzo operatorio</strong><br>
                                        <small style="color: #718096;">Valutazione completa, margini valutabili</small>
                                    </div>
                                </label>
                                <label>
                                    <input type="radio" name="specimenType" value="fnab" 
                                           ${formData.specimenType === 'fnab' ? 'checked' : ''}>
                                    <div>
                                        <strong>FNAB / Citologia</strong><br>
                                        <small style="color: #718096;">Valutazione architetturale limitata</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Ghiandola <span class="required">*</span></label>
                            <select id="gland">
                                <option value="">-- Seleziona --</option>
                                <option value="parotid" ${formData.gland === 'parotid' ? 'selected' : ''}>
                                    Parotide (~80% benigni, 20% maligni)
                                </option>
                                <option value="submandibular" ${formData.gland === 'submandibular' ? 'selected' : ''}>
                                    Sottomandibolare (~50% maligni)
                                </option>
                                <option value="sublingual" ${formData.gland === 'sublingual' ? 'selected' : ''}>
                                    Sottolinguale (~70% maligni)
                                </option>
                                <option value="minor" ${formData.gland === 'minor' ? 'selected' : ''}>
                                    Ghiandole minori (~50-70% maligni)
                                </option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Localizzazione (opzionale)</label>
                            <input type="text" id="location" value="${formData.location || ''}" 
                                   placeholder="Es: lobo superficiale, polo inferiore, palato duro...">
                        </div>
                        
                        <h4>‚ö†Ô∏è Red Flags per Carcinoma ex-PA</h4>
                        <div class="warning-box">
                            I seguenti parametri aumentano il sospetto di trasformazione maligna in PA preesistente
                        </div>
                        
                        <div class="form-group">
                            <label>Storia di adenoma pleomorfo pregresso?</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="priorPA" value="yes" 
                                           ${formData.priorPA === 'yes' ? 'checked' : ''}>
                                    S√¨, documentato
                                </label>
                                <label>
                                    <input type="radio" name="priorPA" value="no" 
                                           ${formData.priorPA === 'no' ? 'checked' : ''}>
                                    No / Non noto
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Lesione presente da >10 anni?</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="longHistory" value="yes" 
                                           ${formData.longHistory === 'yes' ? 'checked' : ''}>
                                    S√¨
                                </label>
                                <label>
                                    <input type="radio" name="longHistory" value="no" 
                                           ${formData.longHistory === 'no' ? 'checked' : ''}>
                                    No / Non noto
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Crescita rapida recente?</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="rapidGrowth" value="yes" 
                                           ${formData.rapidGrowth === 'yes' ? 'checked' : ''}>
                                    S√¨ (incremento significativo negli ultimi mesi)
                                </label>
                                <label>
                                    <input type="radio" name="rapidGrowth" value="no" 
                                           ${formData.rapidGrowth === 'no' ? 'checked' : ''}>
                                    No / Stabile
                                </label>
                            </div>
                        </div>
                        
                        <div class="critical-box" id="caexpaWarning" style="display: none; margin-top: 15px;">
                            <strong>‚ö†Ô∏è IMPORTANTE: Ca ex-PA in biopsia</strong><br>
                            La diagnosi definitiva di Carcinoma ex-PA richiede:
                            <ul style="margin: 10px 0 0 20px; font-size: 12px;">
                                <li>Pezzo operatorio completo (non trucut/biopsia)</li>
                                <li>Identificazione inequivocabile di PA residuo</li>
                                <li>Misurazione dell'invasione oltre la capsula</li>
                            </ul>
                            In biopsia √® possibile solo sospetto morfologico. Il tool applicher√† un penalty score.
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" disabled>‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
            }
            
            // ==================== STEP 2: Malignancy Criteria ====================
            else if (currentStep === 2) {
                html = `
                    <div class="step active">
                        <h3>Step 2/${totalSteps}: Criteri di Malignit√†</h3>
                        
                        <div class="form-group">
                            <label>Infiltrazione Perineurale (PNI)</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="pni" value="no" 
                                           ${formData.pni === 'no' ? 'checked' : ''}>
                                    Assente
                                </label>
                                <label style="background: #fff5f5;">
                                    <input type="radio" name="pni" value="yes" 
                                           ${formData.pni === 'yes' ? 'checked' : ''}>
                                    <div>
                                        <strong style="color: #c53030;">‚ö†Ô∏è PRESENTE</strong><br>
                                        <small>Forte indicatore di malignit√†, tipico di ACC</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Atipia Citologica</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="cytology" value="low" 
                                           ${formData.cytology === 'low' ? 'checked' : ''}>
                                    Bassa / Assente (nuclei uniformi, cromatina regolare)
                                </label>
                                <label>
                                    <input type="radio" name="cytology" value="high" 
                                           ${formData.cytology === 'high' ? 'checked' : ''}>
                                    Alta (pleomorfismo, nucleoli prominenti, cromatina irregolare)
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Necrosi Tumorale</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="necrosis" value="no" 
                                           ${formData.necrosis === 'no' ? 'checked' : ''}>
                                    Assente
                                </label>
                                <label>
                                    <input type="radio" name="necrosis" value="yes" 
                                           ${formData.necrosis === 'yes' ? 'checked' : ''}>
                                    Presente (comedonecrosi o geografica)
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Conta Mitotica (per 10 HPF)</label>
                            <input type="number" id="mitoses" min="0" max="100" 
                                   value="${formData.mitoses || ''}"
                                   placeholder="Numero mitosi / 10 HPF">
                            <small style="color: #718096;">‚â•4 mitosi/10HPF suggestivo di malignit√† in MEC</small>
                        </div>
                        
                        <div class="critical-box">
                            <strong>Nota:</strong> L'infiltrazione perineurale √® il singolo parametro pi√π predittivo 
                            per ACC. La sua presenza deve sempre far sospettare malignit√† anche in contesti 
                            morfologicamente blandi.
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
            }
            
            // ==================== STEP 3: Pattern ====================
            else if (currentStep === 3) {
                html = `
                    <div class="step active">
                        <h3>Step 3/${totalSteps}: Pattern Architetturale</h3>
                        
                        <div class="form-group">
                            <label>Pattern Predominante <span class="required">*</span></label>
                            <div class="radio-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px;">
                                ${Object.entries(patterns).map(([key, p]) => `
                                    <label style="margin: 0;">
                                        <input type="radio" name="pattern" value="${key}" 
                                               ${formData.pattern === key ? 'checked' : ''}>
                                        <div>
                                            <strong>${p.name}</strong><br>
                                            <small style="color: #718096;">${p.description}</small>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Percentuale Componente Solida</label>
                            <input type="number" id="solidPercentage" min="0" max="100" 
                                   value="${formData.solidPercentage || ''}"
                                   placeholder="0-100%">
                            <div class="info-box" style="margin-top: 10px;">
                                <strong>Grading ACC (WHO 2022):</strong><br>
                                ‚Ä¢ Pattern I: solido &lt;30% ‚Üí Prognosi migliore<br>
                                ‚Ä¢ Pattern II: solido 30-70% ‚Üí Intermedia<br>
                                ‚Ä¢ Pattern III: solido &gt;70% ‚Üí Prognosi peggiore
                            </div>
                        </div>
                        
                        <h4>Caratteristiche Aggiuntive</h4>
                        
                        <div class="form-group">
                            <label>Stroma linfoide (per Warthin)</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="lymphoidStroma" value="yes" 
                                           ${formData.lymphoidStroma === 'yes' ? 'checked' : ''}>
                                    Presente (follicoli linfoidi, centri germinativi)
                                </label>
                                <label>
                                    <input type="radio" name="lymphoidStroma" value="no" 
                                           ${formData.lymphoidStroma === 'no' ? 'checked' : ''}>
                                    Assente
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Componente PA residua identificabile (per Ca ex-PA)</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="residualPA" value="yes" 
                                           ${formData.residualPA === 'yes' ? 'checked' : ''}>
                                    S√¨ (aree mixoidi/condroidi benigne residue)
                                </label>
                                <label>
                                    <input type="radio" name="residualPA" value="no" 
                                           ${formData.residualPA === 'no' ? 'checked' : ''}>
                                    No / Non identificabile
                                </label>
                            </div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
            }
            
            // ==================== STEP 4: Base IHC (MODIFICATO v4.1) ====================
            else if (currentStep === 4) {
                html = `
                    <div class="step active">
                        <h3>Step 4/${totalSteps}: Immunoistochimica - Pannello Base</h3>
                        
                        <div class="ihc-grid">
                            <div class="ihc-section">
                                <h5>üî¨ Marcatori Mioepiteliali</h5>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Marcatore</th>
                                            <th>Pos</th>
                                            <th>Neg</th>
                                            <th>Focale</th>
                                            <th>N/E</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>p63</strong></td>
                                            <td><input type="radio" name="p63" value="pos" ${formData.p63 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="p63" value="neg" ${formData.p63 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="p63" value="focal" ${formData.p63 === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="p63" value="nd" ${formData.p63 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                        <tr>
                                            <td><strong>SMA</strong></td>
                                            <td><input type="radio" name="sma" value="pos" ${formData.sma === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="sma" value="neg" ${formData.sma === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="sma" value="focal" ${formData.sma === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="sma" value="nd" ${formData.sma === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Calponina</strong></td>
                                            <td><input type="radio" name="calponin" value="pos" ${formData.calponin === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="calponin" value="neg" ${formData.calponin === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="calponin" value="focal" ${formData.calponin === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="calponin" value="nd" ${formData.calponin === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="info-box" style="margin-top: 10px; font-size: 11px;">
                                    <strong>Interpretazione mantello (5 livelli - v4.1):</strong><br>
                                    ‚Ä¢ <strong>Intatto:</strong> p63+, SMA+, Calponina+ diffusi ‚Üí PA favorito (+4)<br>
                                    ‚Ä¢ <strong>Parziale-PA:</strong> 2/3 positivi o focali ‚Üí PA probabile (+2)<br>
                                    ‚Ä¢ <strong>Indeterminato:</strong> Pattern confuso, discordante ‚Üí neutro (0)<br>
                                    ‚Ä¢ <strong>Parziale-ACC:</strong> p63 scarso/perso, SMA residua ‚Üí ACC probabile (-2)<br>
                                    ‚Ä¢ <strong>Perso:</strong> Tutti negativi ‚Üí ACC favorito (-4)
                                </div>
                            </div>
                            
                            <div class="ihc-section">
                                <h5>üî¨ Marcatori Generali</h5>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Marcatore</th>
                                            <th>Pos</th>
                                            <th>Neg</th>
                                            <th>Focale</th>
                                            <th>N/E</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>CK7</strong></td>
                                            <td><input type="radio" name="ck7" value="pos" ${formData.ck7 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="ck7" value="neg" ${formData.ck7 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="ck7" value="focal" ${formData.ck7 === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="ck7" value="nd" ${formData.ck7 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                        <tr>
                                            <td><strong>S100</strong></td>
                                            <td><input type="radio" name="s100" value="pos" ${formData.s100 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="s100" value="neg" ${formData.s100 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="s100" value="focal" ${formData.s100 === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="s100" value="nd" ${formData.s100 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                        <tr>
                                            <td><strong>DOG1</strong></td>
                                            <td><input type="radio" name="dog1" value="pos" ${formData.dog1 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="dog1" value="neg" ${formData.dog1 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="dog1" value="focal" ${formData.dog1 === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="dog1" value="nd" ${formData.dog1 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                        <tr>
                                            <td><strong>SOX10</strong></td>
                                            <td><input type="radio" name="sox10" value="pos" ${formData.sox10 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="sox10" value="neg" ${formData.sox10 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="sox10" value="focal" ${formData.sox10 === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="sox10" value="nd" ${formData.sox10 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 25px;">
                            <label><strong>Ki-67 Index (%)</strong></label>
                            <input type="number" id="ki67" min="0" max="100" step="0.1" 
                                   value="${formData.ki67 || ''}"
                                   placeholder="Inserisci valore 0-100">
                            <div class="warning-box" style="margin-top: 10px;">
                                <strong>‚ö†Ô∏è Ki-67: parametro instabile (v4.1)</strong><br>
                                ‚Ä¢ ‚â§10% ‚Üí Compatibile con benignit√†<br>
                                ‚Ä¢ 10-20% ‚Üí Zona grigia (non discriminante)<br>
                                ‚Ä¢ &gt;20% ‚Üí Sospetto per malignit√†<br>
                                <br>
                                <strong style="color: #c05621;">Nota critica:</strong> Hot spot selection, tecnica IHC e clone anticorpale 
                                influenzano pesantemente il risultato. PA cellulati possono raggiungere 15-20% senza malignit√†.
                                Interpretare sempre in contesto morfologico. Peso ridotto nello scoring.
                            </div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
            }
            
            // ==================== STEP 5: Discriminant IHC ====================
            else if (currentStep === 5) {
                html = `
                    <div class="step active">
                        <h3>Step 5/${totalSteps}: IHC Discriminanti</h3>
                        
                        <div class="ihc-grid">
                            <div class="ihc-section">
                                <h5>üéØ PA vs ACC (Cruciali)</h5>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Marcatore</th>
                                            <th>Pos</th>
                                            <th>Neg</th>
                                            <th>Focale</th>
                                            <th>N/E</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr style="background: #f0fff4;">
                                            <td>
                                                <strong>LEF1</strong><br>
                                                <small style="color: #276749;">‚≠ê Key discriminant</small>
                                            </td>
                                            <td><input type="radio" name="lef1" value="pos" ${formData.lef1 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="lef1" value="neg" ${formData.lef1 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="lef1" value="focal" ${formData.lef1 === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="lef1" value="nd" ${formData.lef1 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                        <tr>
                                            <td><strong>CD117</strong> (c-Kit)</td>
                                            <td><input type="radio" name="cd117" value="pos" ${formData.cd117 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="cd117" value="neg" ${formData.cd117 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="cd117" value="focal" ${formData.cd117 === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="cd117" value="nd" ${formData.cd117 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                        <tr>
                                            <td><strong>BCL2</strong></td>
                                            <td><input type="radio" name="bcl2" value="pos" ${formData.bcl2 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="bcl2" value="neg" ${formData.bcl2 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="bcl2" value="focal" ${formData.bcl2 === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="bcl2" value="nd" ${formData.bcl2 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="success-box" style="margin-top: 10px; font-size: 11px;">
                                    <strong>LEF1 positivo = PA</strong><br>
                                    LEF1 √® virtualmente ASSENTE in ACC.<br>
                                    Sensibilit√† >95% per escludere ACC.
                                </div>
                            </div>
                            
                            <div class="ihc-section">
                                <h5>üéØ SDC / Duttale</h5>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Marcatore</th>
                                            <th>Pos</th>
                                            <th>Neg</th>
                                            <th>Focale</th>
                                            <th>N/E</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <strong>AR</strong><br>
                                                <small style="color: #718096;">Recettore androgeni</small>
                                            </td>
                                            <td><input type="radio" name="ar" value="pos" ${formData.ar === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="ar" value="neg" ${formData.ar === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="ar" value="focal" ${formData.ar === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="ar" value="nd" ${formData.ar === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <strong>HER2</strong><br>
                                                <small style="color: #718096;">IHC / FISH</small>
                                            </td>
                                            <td><input type="radio" name="her2" value="pos" ${formData.her2 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="her2" value="neg" ${formData.her2 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="her2" value="amplified" ${formData.her2 === 'amplified' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="her2" value="nd" ${formData.her2 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                        <tr>
                                            <td><strong>GCDFP-15</strong></td>
                                            <td><input type="radio" name="gcdfp15" value="pos" ${formData.gcdfp15 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="gcdfp15" value="neg" ${formData.gcdfp15 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="gcdfp15" value="focal" ${formData.gcdfp15 === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="gcdfp15" value="nd" ${formData.gcdfp15 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="warning-box" style="margin-top: 10px; font-size: 11px;">
                                    <strong>SDC:</strong> AR+ (~90%), HER2+ (~30-40%)<br>
                                    Target terapeutici potenziali!
                                </div>
                            </div>
                            
                            <div class="ihc-section">
                                <h5>üéØ Acinare / MASC</h5>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Marcatore</th>
                                            <th>Pos</th>
                                            <th>Neg</th>
                                            <th>Focale</th>
                                            <th>N/E</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>Mammaglobina</strong></td>
                                            <td><input type="radio" name="mammaglobin" value="pos" ${formData.mammaglobin === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="mammaglobin" value="neg" ${formData.mammaglobin === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="mammaglobin" value="focal" ${formData.mammaglobin === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="mammaglobin" value="nd" ${formData.mammaglobin === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Pan-TRK</strong></td>
                                            <td><input type="radio" name="pantrk" value="pos" ${formData.pantrk === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="pantrk" value="neg" ${formData.pantrk === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="pantrk" value="focal" ${formData.pantrk === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="pantrk" value="nd" ${formData.pantrk === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="ihc-section">
                                <h5>üéØ MEC</h5>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Marcatore</th>
                                            <th>Pos</th>
                                            <th>Neg</th>
                                            <th>Focale</th>
                                            <th>N/E</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><strong>CK5/6</strong></td>
                                            <td><input type="radio" name="ck5_6" value="pos" ${formData.ck5_6 === 'pos' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="ck5_6" value="neg" ${formData.ck5_6 === 'neg' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="ck5_6" value="focal" ${formData.ck5_6 === 'focal' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="ck5_6" value="nd" ${formData.ck5_6 === 'nd' ? 'checked' : ''}></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
            }
            
            // ==================== STEP 6: Molecular ====================
            else if (currentStep === 6) {
                html = `
                    <div class="step active">
                        <h3>Step 6/${totalSteps}: Studi Molecolari (FISH / NGS)</h3>
                        
                        <div class="critical-box">
                            <strong>‚ö†Ô∏è Nota importante:</strong> Un risultato negativo NON esclude la diagnosi. 
                            I riarrangiamenti non sono presenti nel 100% dei casi. La morfologia e l'IHC rimangono fondamentali.
                        </div>
                        
                        <div class="ihc-grid">
                            <div class="ihc-section">
                                <h5>üß¨ ACC</h5>
                                <div class="form-group">
                                    <label><strong>MYB-NFIB / MYBL1</strong> (FISH)</label>
                                    <div class="radio-group">
                                        <label style="background: #faf5ff;">
                                            <input type="radio" name="myb" value="pos" ${formData.myb === 'pos' ? 'checked' : ''}>
                                            <div>
                                                <strong style="color: #553c9a;">POSITIVO</strong><br>
                                                <small>Presente in ~80% ACC - diagnostico</small>
                                            </div>
                                        </label>
                                        <label>
                                            <input type="radio" name="myb" value="neg" ${formData.myb === 'neg' ? 'checked' : ''}>
                                            Negativo
                                        </label>
                                        <label>
                                            <input type="radio" name="myb" value="nd" ${formData.myb === 'nd' ? 'checked' : ''}>
                                            Non eseguito
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ihc-section">
                                <h5>üß¨ PA</h5>
                                <div class="form-group">
                                    <label><strong>PLAG1</strong> (FISH)</label>
                                    <div class="radio-group">
                                        <label style="background: #f0fff4;">
                                            <input type="radio" name="plag1" value="pos" ${formData.plag1 === 'pos' ? 'checked' : ''}>
                                            <div>
                                                <strong style="color: #276749;">POSITIVO</strong><br>
                                                <small>~70% PA - gold standard</small>
                                            </div>
                                        </label>
                                        <label>
                                            <input type="radio" name="plag1" value="neg" ${formData.plag1 === 'neg' ? 'checked' : ''}>
                                            Negativo
                                        </label>
                                        <label>
                                            <input type="radio" name="plag1" value="nd" ${formData.plag1 === 'nd' ? 'checked' : ''}>
                                            Non eseguito
                                        </label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label><strong>HMGA2</strong> (FISH)</label>
                                    <div class="radio-group">
                                        <label>
                                            <input type="radio" name="hmga2" value="pos" ${formData.hmga2 === 'pos' ? 'checked' : ''}>
                                            Positivo (~30% PA)
                                        </label>
                                        <label>
                                            <input type="radio" name="hmga2" value="neg" ${formData.hmga2 === 'neg' ? 'checked' : ''}>
                                            Negativo
                                        </label>
                                        <label>
                                            <input type="radio" name="hmga2" value="nd" ${formData.hmga2 === 'nd' ? 'checked' : ''}>
                                            Non eseguito
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ihc-section">
                                <h5>üß¨ Carcinoma Acinare</h5>
                                <div class="form-group">
                                    <label><strong>NR4A3</strong> (FISH)</label>
                                    <div class="radio-group">
                                        <label style="background: #faf5ff;">
                                            <input type="radio" name="nr4a3" value="pos" ${formData.nr4a3 === 'pos' ? 'checked' : ''}>
                                            <div>
                                                <strong style="color: #553c9a;">POSITIVO</strong><br>
                                                <small>Altamente specifico per AciCC</small>
                                            </div>
                                        </label>
                                        <label>
                                            <input type="radio" name="nr4a3" value="neg" ${formData.nr4a3 === 'neg' ? 'checked' : ''}>
                                            Negativo
                                        </label>
                                        <label>
                                            <input type="radio" name="nr4a3" value="nd" ${formData.nr4a3 === 'nd' ? 'checked' : ''}>
                                            Non eseguito
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ihc-section">
                                <h5>üß¨ MASC</h5>
                                <div class="form-group">
                                    <label><strong>ETV6-NTRK3</strong> (FISH / NGS)</label>
                                    <div class="radio-group">
                                        <label style="background: #faf5ff;">
                                            <input type="radio" name="etv6" value="pos" ${formData.etv6 === 'pos' ? 'checked' : ''}>
                                            <div>
                                                <strong style="color: #553c9a;">POSITIVO</strong><br>
                                                <small>PATOGNOMONICO per MASC</small>
                                            </div>
                                        </label>
                                        <label>
                                            <input type="radio" name="etv6" value="neg" ${formData.etv6 === 'neg' ? 'checked' : ''}>
                                            Negativo
                                        </label>
                                        <label>
                                            <input type="radio" name="etv6" value="nd" ${formData.etv6 === 'nd' ? 'checked' : ''}>
                                            Non eseguito
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="ihc-section">
                                <h5>üß¨ MEC</h5>
                                <div class="form-group">
                                    <label><strong>MAML2</strong> (CRTC1/3-MAML2, FISH)</label>
                                    <div class="radio-group">
                                        <label>
                                            <input type="radio" name="maml2" value="pos" ${formData.maml2 === 'pos' ? 'checked' : ''}>
                                            Positivo (~50-70% MEC, prognosi favorevole)
                                        </label>
                                        <label>
                                            <input type="radio" name="maml2" value="neg" ${formData.maml2 === 'neg' ? 'checked' : ''}>
                                            Negativo
                                        </label>
                                        <label>
                                            <input type="radio" name="maml2" value="nd" ${formData.maml2 === 'nd' ? 'checked' : ''}>
                                            Non eseguito
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-box">
                            <strong>Gerarchia diagnostica molecolare:</strong><br>
                            1. ETV6-NTRK3+ ‚Üí MASC (patognomonico)<br>
                            2. MYB-NFIB+ ‚Üí ACC (~80%)<br>
                            3. NR4A3+ ‚Üí Carcinoma acinare<br>
                            4. PLAG1+ o HMGA2+ ‚Üí PA<br>
                            5. MAML2+ ‚Üí MEC (50-70%, prognosticamente favorevole)
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
            }
            
            // ==================== STEP 7: Grading ====================
            else if (currentStep === 7) {
                html = `
                    <div class="step active">
                        <h3>Step 7/${totalSteps}: Grading (se applicabile)</h3>
                        
                        <div class="grading-box">
                            <h4>üìä Grading MEC (Sistema AFIP/Brandwein)</h4>
                            <p style="margin-bottom: 15px; color: #553c9a;">
                                Seleziona i parametri presenti. Il sistema calcola automaticamente il grado.
                            </p>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Parametro</th>
                                        <th>Punti</th>
                                        <th>Presente</th>
                                        <th>Assente</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${gradingSystems.MEC.parameters.map(p => `
                                        <tr>
                                            <td>${p.label}</td>
                                            <td><strong>+${p.points}</strong></td>
                                            <td><input type="radio" name="${p.id}" value="yes" ${formData[p.id] === 'yes' ? 'checked' : ''}></td>
                                            <td><input type="radio" name="${p.id}" value="no" ${formData[p.id] === 'no' ? 'checked' : ''}></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <div class="info-box" style="margin-top: 15px;">
                                <strong>Interpretazione:</strong><br>
                                ‚Ä¢ 0-4 punti: Basso grado ‚Üí Prognosi eccellente<br>
                                ‚Ä¢ 5-6 punti: Grado intermedio ‚Üí Prognosi intermedia<br>
                                ‚Ä¢ ‚â•7 punti: Alto grado ‚Üí Prognosi sfavorevole
                            </div>
                        </div>
                        
                        <div class="grading-box" style="margin-top: 25px;">
                            <h4>üìè Invasione Ca ex-PA (WHO 2022)</h4>
                            <p style="margin-bottom: 15px; color: #553c9a;">
                                Misura dell'invasione oltre la capsula del PA preesistente
                            </p>
                            <div class="form-group">
                                <label><strong>Estensione invasione (mm)</strong></label>
                                <input type="number" id="invasionMm" min="0" max="100" step="0.1"
                                       value="${formData.invasionMm || ''}"
                                       placeholder="mm oltre la capsula">
                            </div>
                            <div class="info-box">
                                <strong>Classificazione WHO 2022:</strong><br>
                                ‚Ä¢ ‚â§1.5mm: Minimamente invasivo ‚Üí Prognosi eccellente (simile a PA)<br>
                                ‚Ä¢ 1.5-4mm: Invasivo ‚Üí Prognosi intermedia<br>
                                ‚Ä¢ &gt;4mm: Ampiamente invasivo ‚Üí Prognosi riservata
                            </div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
            }
            
            // ==================== STEP 8: Clinical Info ====================
            else if (currentStep === 8) {
                html = `
                    <div class="step active">
                        <h3>Step 8/${totalSteps}: Informazioni Cliniche</h3>
                        
                        <div class="form-group">
                            <label>Sospetto Clinico Iniziale (opzionale)</label>
                            <input type="text" id="clinicalSuspicion" 
                                   value="${formData.clinicalSuspicion || ''}"
                                   placeholder="Es: Adenoma pleomorfo, ACC, MEC...">
                            <small style="color: #718096;">
                                Inserisci il sospetto del clinico referente per valutare la concordanza
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label>Note Cliniche e Red Flags</label>
                            <textarea id="clinicalNotes" rows="4"
                                      placeholder="Informazioni rilevanti: durata lesione, sintomi (dolore, paralisi facciale), precedenti biopsie, imaging...">${formData.clinicalNotes || ''}</textarea>
                        </div>
                        
                        <div class="info-box">
                            <strong>Informazioni utili per la correlazione:</strong><br>
                            ‚Ä¢ Durata della lesione e pattern di crescita<br>
                            ‚Ä¢ Sintomi neurologici (paralisi facciale = red flag)<br>
                            ‚Ä¢ Dolore (raro nei benigni)<br>
                            ‚Ä¢ Precedenti interventi o biopsie<br>
                            ‚Ä¢ Imaging (cisti? captazione?)<br>
                            ‚Ä¢ Bilateralit√† (tipica Warthin)
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">üìä Visualizza Risultati ‚Üí</button>
                        </div>
                    </div>
                `;
            }
            
            // ==================== STEP 9: Results (MODIFICATO v4.1) ====================
            else if (currentStep === 9) {
                saveData();
                const results = computeResults();
                
                // Check concordance with clinical suspicion
                let concordanceHTML = '';
                if (formData.clinicalSuspicion) {
                    const suspLower = formData.clinicalSuspicion.toLowerCase();
                    const topDiag = results[0]?.name.toLowerCase() || '';
                    const isMatch = topDiag.includes(suspLower) || suspLower.includes(topDiag) ||
                                   (suspLower.includes('pa') && topDiag.includes('pleomorfo')) ||
                                   (suspLower.includes('acc') && topDiag.includes('adenoidocistico'));
                    
                    if (isMatch) {
                        concordanceHTML = `
                            <div class="success-box">
                                <strong>‚úÖ CONCORDANZA CLINICO-PATOLOGICA</strong><br>
                                Sospetto clinico "${formData.clinicalSuspicion}" concorda con la prima diagnosi differenziale.
                            </div>
                        `;
                    } else {
                        concordanceHTML = `
                            <div class="warning-box">
                                <strong>‚ö†Ô∏è DISCORDANZA</strong><br>
                                Sospetto clinico "${formData.clinicalSuspicion}" non corrisponde alla diagnosi pi√π probabile (${results[0]?.name}).<br>
                                Rivalutare morfologia e/o richiedere correlazione clinica.
                            </div>
                        `;
                    }
                }
                
                // NUOVO v4.1: Warning per score ravvicinati
                let closeScoresHTML = '';
                if (results[0]?.closeScoresWarning) {
                    const w = results[0].closeScoresWarning;
                    closeScoresHTML = `
                        <div class="warning-box" style="margin-bottom: 20px;">
                            <strong>‚ö†Ô∏è SCORE RAVVICINATI</strong><br>
                            La differenza tra <strong>${w.top1}</strong> 
                            e <strong>${w.top2}</strong> √® solo di 
                            <strong>${w.diff} punt${w.diff === 1 ? 'o' : 'i'}</strong>.<br>
                            <br>
                            Diagnosi differenziale serrata. Essenziale:
                            <ul style="margin: 10px 0 0 20px; font-size: 12px;">
                                <li>Rivalutare morfologia HE</li>
                                <li>Completare pannello IHC (LEF1, SOX10, CD117)</li>
                                <li>Considerare studi molecolari (FISH/NGS)</li>
                                <li>Correlazione clinico-radiologica</li>
                            </ul>
                        </div>
                    `;
                }
                
                html = `
                    <div class="step active">
                        <h3>Step 9/${totalSteps}: Diagnosi Differenziale</h3>
                        
                        ${concordanceHTML}
                        ${closeScoresHTML}
                        
                        ${formData.specimenType === 'fnab' ? `
                            <div class="critical-box" style="margin-bottom: 20px;">
                                <strong>‚ö†Ô∏è CAMPIONE CITOLOGICO (FNAB)</strong><br>
                                La valutazione citologica presenta limitazioni intrinseche:
                                <ul style="margin: 10px 0 0 20px; font-size: 12px;">
                                    <li>Architettura tissutale <strong>non valutabile</strong></li>
                                    <li>Invasione, PNI, mantello mioepiteliale <strong>non valutabili</strong></li>
                                    <li>IHC possibile solo su cell block (se disponibile)</li>
                                    <li>Grading istologico <strong>impossibile</strong></li>
                                </ul>
                                <br>
                                <strong>Diagnosi definitiva richiede biopsia core o pezzo operatorio.</strong>
                                <br>
                                I risultati del tool vanno interpretati come <strong>orientamento citologico</strong>, 
                                non diagnosi istologica definitiva.
                            </div>
                        ` : ''}
                        
                        <div class="info-box" style="margin-bottom: 20px;">
                            <strong>üìä Come interpretare gli score (v4.1):</strong><br>
                            Lo score riflette la somma pesata dei criteri morfologici, IHC e molecolari inseriti.
                            <strong>Non √® una probabilit√† diagnostica assoluta</strong>, ma un indice di compatibilit√† 
                            con i dati forniti. Score simili richiedono integrazione con dati aggiuntivi.
                            <br><br>
                            <strong>Modifiche v4.1:</strong> Ki-67 con peso ridotto e cut-off aggiornati; 
                            mantello mioepiteliale a 5 livelli; penalty per Ca ex-PA in trucut.
                        </div>
                        
                        <div class="warning-box" style="margin-bottom: 20px;">
                            <strong>‚ö†Ô∏è PATTERN NON CLASSIFICABILE?</strong><br>
                            Questo tool copre le <strong>8 entit√† pi√π comuni</strong> (PA, ACC, MEC, AciCC, MASC, SDC, Warthin, Ca ex-PA).
                            <br><br>
                            Se la morfologia <strong>non si adatta a nessuna</strong> delle diagnosi proposte, considera entit√† rare:
                            <ul style="margin: 8px 0 0 20px; font-size: 12px;">
                                <li><strong>EMC</strong> (Epithelial-Myoepithelial Ca): architettura bifasica netta</li>
                                <li><strong>PAC</strong> (Polymorphous Adenocarcinoma): pattern papillare/cribriforme uniforme, ghiandole minori</li>
                                <li><strong>HCCC</strong> (Hyalinizing Clear Cell Ca): cellule chiare + stroma ialino, EWSR1+</li>
                                <li><strong>BCA</strong> (Basal Cell Adenoma): basaloide benigno, mantello intatto</li>
                                <li><strong>Oncocitoma</strong>: oncocitario puro senza stroma linfoide</li>
                            </ul>
                            <br>
                            In questi casi: <strong>consulta WHO 2022</strong> per criteri diagnostici o <strong>richiedi consulenza terziaria</strong>.
                        </div>
                        
                        <div class="report-section">
                            <h4>üìä Ranking Diagnostico (click per dettagli)</h4>
                            ${results.length === 0 ? `
                                <div class="warning-box">
                                    Dati insufficienti per generare una diagnosi differenziale.
                                    Tornare agli step precedenti e completare i parametri.
                                </div>
                            ` : results.slice(0, 6).map((r, i) => `
                                <div class="diagnosis-card ${r.confidence}" onclick="this.classList.toggle('expanded')">
                                    <div class="header-row">
                                        <div class="diagnosis-name">${i + 1}. ${r.fullName}</div>
                                        <span class="confidence-badge ${r.confidence}">
                                            ${r.confidence === 'molecular' ? 'üß¨ MOLECULAR' : r.confidence.toUpperCase()}
                                        </span>
                                    </div>
                                    <div style="font-size: 12px; color: #718096; margin-bottom: 8px;">
                                        Comportamento: ${r.behavior}
                                    </div>
                                    <div class="score-bar">
                                        <div class="score-fill" style="width: ${r.percentage}%"></div>
                                    </div>
                                    <div style="font-size: 10px; color: #a0aec0; font-weight: 400;" title="Score comparativo interno (non lineare, non probabilistico). Riflette compatibilit√† relativa con i dati inseriti, NON certezza diagnostica. Valori assoluti non confrontabili tra casi diversi.">
                                        Score indicativo: ${r.score} ¬±2 <span style="opacity: 0.6;">| ${r.percentage}% max</span> ‚ÑπÔ∏è
                                    </div>
                                    ${r.grading ? `
                                        <div style="margin-top: 10px; padding: 10px; background: #faf5ff; border-radius: 6px;">
                                            <strong style="color: #553c9a;">GRADING: ${r.grading.grade}</strong><br>
                                            <small>${r.grading.description}<br>Prognosi: ${r.grading.prognosis}</small>
                                        </div>
                                    ` : ''}
                                    <div class="rationale">
                                        <strong>Criteri supportivi:</strong>
                                        ${r.rationale.map(rat => `
                                            <div class="rationale-item ${rat.type}">
                                                ${rat.text}
                                                <span class="evidence-tag ${rat.tag}">${rat.tag}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="report-section">
                            <h4>üìã Riepilogo Parametri Chiave</h4>
                            <table style="font-size: 12px;">
                                <tr>
                                    <td><strong>Ghiandola:</strong></td>
                                    <td>${formData.gland || 'N/D'}</td>
                                    <td><strong>Pattern:</strong></td>
                                    <td>${formData.pattern ? patterns[formData.pattern]?.name : 'N/D'}</td>
                                </tr>
                                <tr>
                                    <td><strong>Ki-67:</strong></td>
                                    <td>${formData.ki67 ? formData.ki67 + '%' : 'N/D'}</td>
                                    <td><strong>PNI:</strong></td>
                                    <td>${formData.pni === 'yes' ? '‚ö†Ô∏è PRESENTE' : (formData.pni === 'no' ? 'Assente' : 'N/D')}</td>
                                </tr>
                                <tr>
                                    <td><strong>LEF1:</strong></td>
                                    <td>${formData.lef1 || 'N/D'}</td>
                                    <td><strong>MYB-NFIB:</strong></td>
                                    <td>${formData.myb === 'pos' ? 'üß¨ POSITIVO' : (formData.myb || 'N/D')}</td>
                                </tr>
                            </table>
                        </div>
                        
                        ${formData.clinicalNotes ? `
                            <div class="report-section">
                                <h4>üìù Note Cliniche</h4>
                                <p style="font-size: 13px; color: #4a5568;">${formData.clinicalNotes}</p>
                            </div>
                        ` : ''}
                        
                        <div class="warning-box">
                            <strong>‚ö†Ô∏è Interpretazione:</strong> Questi risultati sono indicazioni probabilistiche basate sui parametri inseriti.
                            La diagnosi finale richiede sempre integrazione con la morfologia HE completa, il pannello IHC, 
                            gli studi molecolari e la correlazione clinico-radiologica. La responsabilit√† diagnostica rimane del patologo.
                        </div>
                        
                        <div style="margin-top: 30px; display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn-primary" onclick="downloadTextReport()" style="flex: none;">
                                üìÑ Scarica Report TXT
                            </button>
                            <button class="btn-secondary" onclick="goToStep(1)">
                                ‚úèÔ∏è Modifica Dati
                            </button>
                            <button class="btn-secondary" onclick="if(confirm('Iniziare un nuovo caso? I dati correnti verranno persi.')) location.reload();">
                                üîÑ Nuovo Caso
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('mainContent').innerHTML = html;
            updateProgress();
            
            // NUOVO v4.1: Event listeners per warning Ca ex-PA
            if (currentStep === 1) {
                setTimeout(() => {
                    document.querySelectorAll('input[name="specimenType"], input[name="priorPA"]').forEach(el => {
                        el.addEventListener('change', function() {
                            const isTrucut = document.querySelector('input[name="specimenType"]:checked')?.value === 'trucut';
                            const hasPriorPA = document.querySelector('input[name="priorPA"]:checked')?.value === 'yes';
                            const warning = document.getElementById('caexpaWarning');
                            if (warning) {
                                warning.style.display = (isTrucut && hasPriorPA) ? 'block' : 'none';
                            }
                        });
                    });
                }, 100);
            }
        }

        // ========== INITIALIZATION ==========
        window.onload = function() {
            render();
        };
    </script>
</body>
</html>
