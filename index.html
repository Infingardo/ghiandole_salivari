<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salivary Gland Diagnostic Support Tool v3.2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 28px; margin-bottom: 5px; }
        .header p { font-size: 13px; opacity: 0.9; }
        
        /* Disclaimer prominente */
        .main-disclaimer {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
            padding: 20px;
            margin: 0;
            font-weight: 600;
            text-align: center;
        }
        .main-disclaimer strong {
            display: block;
            font-size: 18px;
            margin-bottom: 10px;
            color: #dc3545;
        }
        
        .progress-bar { height: 4px; background: #e0e0e0; }
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); 
            transition: width 0.3s ease; 
        }
        .content { padding: 40px; }
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        h3 { font-size: 22px; color: #333; margin-bottom: 20px; font-weight: 600; }
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            color: #333; 
            font-weight: 500; 
            font-size: 14px; 
        }
        input[type="number"], input[type="text"], select, textarea { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 14px; 
            font-family: inherit;
        }
        input[type="number"]:focus, input[type="text"]:focus, select:focus, textarea:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); 
        }
        textarea { resize: vertical; min-height: 80px; }
        
        .radio-group, .checkbox-group { margin-top: 10px; }
        .radio-group label, .checkbox-group label { 
            display: flex; 
            align-items: center; 
            margin: 8px 0; 
            cursor: pointer; 
        }
        input[type="radio"], input[type="checkbox"] { margin-right: 8px; }
        
        .info-box { 
            background: #f0f4ff; 
            border-left: 4px solid #667eea; 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 4px; 
            font-size: 13px; 
            color: #444; 
        }
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 13px;
            color: #856404;
        }
        .critical-box { 
            background: #f8d7da; 
            border-left: 4px solid #dc3545; 
            padding: 15px; 
            margin: 20px 0; 
            font-size: 13px; 
            color: #721c24; 
        }
        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 13px;
            color: #155724;
        }
        
        .buttons { 
            display: flex; 
            gap: 12px; 
            margin-top: 40px; 
        }
        button { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            flex: 1; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); 
        }
        .btn-secondary { 
            background: #e0e0e0; 
            color: #333; 
        }
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 13px; 
            margin: 15px 0; 
        }
        th { 
            background: #f0f4ff; 
            padding: 10px; 
            text-align: left; 
            font-weight: 600; 
            border-bottom: 2px solid #667eea; 
        }
        td { 
            padding: 10px; 
            border-bottom: 1px solid #ddd; 
        }
        
        .diagnosis-rank { 
            background: #f8f9fa; 
            border: 1px solid #ddd; 
            border-left: 5px solid #ffc107; 
            border-radius: 8px; 
            padding: 15px; 
            margin: 12px 0; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .diagnosis-rank:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .diagnosis-rank.high { border-left-color: #28a745; }
        .diagnosis-rank.moderate { border-left-color: #ffc107; }
        .diagnosis-rank.low { border-left-color: #dc3545; }
        .diagnosis-rank.borderline { 
            border-left-color: #6c757d; 
            background: #fff3cd;
        }
        .diagnosis-rank.expanded .rationale { display: block; }
        .rationale { 
            display: none; 
            font-size: 12px; 
            color: #555; 
            margin-top: 10px; 
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        
        .footer { 
            text-align: center; 
            font-size: 12px; 
            color: #999; 
            margin-top: 30px; 
            padding: 20px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0; 
        }
        
        /* Stili per il report finale */
        .final-report {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .report-section {
            margin-bottom: 25px;
        }
        .report-section h4 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 10px;
            border-bottom: 2px solid #f0f4ff;
            padding-bottom: 5px;
        }
        
        /* Validazione visiva */
        input:invalid {
            border-color: #dc3545;
        }
        .validation-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
        
        /* Bibliografia Sidebar */
        .biblio-sidebar {
            position: fixed;
            right: -420px;
            top: 0;
            width: 420px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .biblio-sidebar.open {
            right: 0;
        }
        
        .biblio-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.3s;
            z-index: 999;
        }
        
        .biblio-toggle:hover {
            transform: scale(1.1);
        }
        
        .biblio-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .biblio-close {
            float: right;
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .biblio-content {
            padding: 20px;
        }
        
        .biblio-filter {
            margin-bottom: 15px;
            padding: 10px;
            background: #f0f4ff;
            border-radius: 6px;
        }
        
        .biblio-filter span {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            margin: 3px;
            font-size: 11px;
        }
        
        .ref-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .ref-item.hidden {
            display: none;
        }
        
        .ref-item .authors {
            font-weight: 600;
            color: #333;
        }
        
        .ref-item .title {
            font-style: italic;
            color: #555;
            margin: 5px 0;
        }
        
        .ref-item .journal {
            color: #666;
            font-size: 11px;
        }
        
        .ref-item .tags {
            margin-top: 8px;
        }
        
        .ref-tag {
            display: inline-block;
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin: 2px;
            color: #555;
        }
        
        .ref-links {
            margin-top: 8px;
        }
        
        .ref-links a {
            color: #667eea;
            text-decoration: none;
            margin-right: 10px;
            font-size: 11px;
        }
        
        .ref-links a:hover {
            text-decoration: underline;
        }
        
        .evidence-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 5px;
        }
        
        .evidence-who { background: #28a745; color: white; }
        .evidence-cohort { background: #ffc107; color: #333; }
        .evidence-case { background: #17a2b8; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ Salivary Gland Diagnostic Support Tool</h1>
            <p>v3.2 - Strumento di supporto per diagnosi differenziale neoplasie ghiandole salivari</p>
        </div>
        
        <div class="main-disclaimer">
            <strong>‚ö†Ô∏è DISCLAIMER IMPORTANTE</strong>
            Questo √® uno strumento di SUPPORTO didattico e diagnostico. 
            NON sostituisce il giudizio clinico-patologico completo. 
            Ogni caso richiede correlazione con morfologia HE, clinica e imaging.
            I risultati sono indicazioni probabilistiche, NON diagnosi definitive.
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="content" id="mainContent">
            <!-- Contenuto generato da JavaScript -->
        </div>
        
        <div class="footer">
            <p><strong>Strumento di supporto diagnostico</strong></p>
            <p>Sviluppato secondo linee guida WHO 2022 - NON sostituisce valutazione patologica completa</p>
            <p>Per uso didattico e di orientamento diagnostico | v3.2 ¬© 2025</p>
        </div>
    </div>

    <!-- Bibliografia Sidebar -->
    <div class="biblio-sidebar" id="biblioSidebar">
        <div class="biblio-header">
            <button class="biblio-close" onclick="toggleBiblio()">√ó</button>
            <h3 style="margin: 0;">üìö Bibliografia Contestuale</h3>
            <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.9;">
                Filtrabile in base ai parametri del caso
            </p>
        </div>
        
        <div class="biblio-content">
            <div class="biblio-filter" id="biblioFilter">
                <strong style="display: block; margin-bottom: 5px;">Filtri attivi:</strong>
                <div id="activeFilters"></div>
            </div>
            
            <div id="biblioRefs">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <button class="biblio-toggle" onclick="toggleBiblio()" title="Bibliografia">
        üìö
    </button>

    <script>
        // ========== CONFIGURAZIONE E DATI ==========
        let currentStep = 1;
        const totalSteps = 8;
        let formData = {};

        const patterns = {
            basaloid: { 
                name: "Basaloide", 
                markers: ["SOX10", "CD117", "BCL2", "Œ≤-catenina nucleare", "LEF1 (discriminante PA/ACC)"] 
            },
            cribriform: { 
                name: "Cribriforme", 
                markers: ["CD117", "PAS+D membrana basale", "SOX10", "LEF1 (negativo in ACC)"] 
            },
            acinic: { 
                name: "Acinare", 
                markers: ["DOG1", "Mammaglobina", "Amilasi", "Pan-TRK"] 
            },
            oncocytic: { 
                name: "Oncocitario", 
                markers: ["DOG1", "CEA", "Amilasi"] 
            },
            mucoepidermoid: { 
                name: "Mucoepidermoide", 
                markers: ["CK5/6", "MUC5AC", "MAML2"] 
            },
            pleomorphic: { 
                name: "Pleomorfo", 
                markers: ["PLAG1", "HMGA2", "GFAP", "LEF1 (positivo in PA)"] 
            },
            clear_cell: { 
                name: "Cellule Chiare", 
                markers: ["EWSR1-ATF1", "RAS Q61R"] 
            },
            squamous: { 
                name: "Squamoso", 
                markers: ["CK5/6", "CK7", "p16"] 
            },
            ductal: { 
                name: "Duttale", 
                markers: ["AR", "HER2", "GCDFP-15"] 
            }
        };

        // Mappatura sinonimi per confronto diagnosi
        const tumorSynonyms = {
            'warthin': ['tumore di warthin', 'warthin', 'cistoadenolinfoma', 'adenolinfoma'],
            'adenoma pleomorfo': ['adenoma pleomorfo', 'pleomorfo', 'tumore misto', 'mixed tumor', 'pa'],
            'adenoidocistico': ['acc', 'adenoidocistico', 'adenoid cystic', 'carcinoma adenoidocistico'],
            'carcinoma acinare': ['acinare', 'acinico', 'carcinoma acinare', 'acinic'],
            'mucoepidermoide': ['mec', 'mucoepidermoide', 'carcinoma mucoepidermoide', 'mucoepidermoid'],
            'carcinoma duttale': ['carcinoma duttale', 'salivary duct', 'sdc', 'carcinoma duttale salivare'],
            'adenoma oncocitario': ['oncocitario', 'oncocitoma', 'adenoma oncocitario'],
            'masc': ['masc', 'mammary analog secretory', 'carcinoma secretorio'],
            'carcinoma ex pa': ['carcinoma ex adenoma pleomorfo', 'ca ex pa', 'trasformazione maligna']
        };

        // ========== BIBLIOGRAFIA DATABASE ==========
        const references = [
            {
                id: 1,
                authors: "WHO Classification of Tumours Editorial Board",
                title: "Head and neck tumours. Chapter: Salivary Glands",
                journal: "WHO Classification Series, 5th ed., vol. 9, pp. 185-279",
                year: 2022,
                doi: null,
                pmid: null,
                iarc: "https://tumourclassification.iarc.who.int/chapters/52",
                tags: ["WHO", "PA", "ACC", "MEC", "MASC", "grading", "classification"],
                evidence: "who"
            },
            {
                id: 2,
                authors: "Persson M, et al.",
                title: "Recurrent fusion of MYB and NFIB transcription factor genes in carcinomas",
                journal: "Proc Natl Acad Sci USA. 2009;106(44):18740-4",
                year: 2009,
                doi: "10.1073/pnas.0909114106",
                pmid: "19841262",
                tags: ["ACC", "MYB-NFIB", "molecular"],
                evidence: "cohort"
            },
            {
                id: 3,
                authors: "Chiosea SI, et al.",
                title: "Adenoid cystic carcinoma: current therapies and molecular targets",
                journal: "Expert Opin Ther Targets. 2021;25(3):171-182",
                year: 2021,
                doi: "10.1080/14728222.2021.1908263",
                pmid: "33760671",
                tags: ["ACC", "MYB-NFIB", "therapy", "prognosis"],
                evidence: "cohort"
            },
            {
                id: 4,
                authors: "Katabi N, et al.",
                title: "Prognostic features in adenoid cystic carcinoma of major and minor salivary glands",
                journal: "Cancer. 2015;121(7):1059-68",
                year: 2015,
                doi: "10.1002/cncr.29151",
                pmid: "25521441",
                tags: ["ACC", "PNI", "grading", "prognosis"],
                evidence: "cohort"
            },
            {
                id: 5,
                authors: "Sk√°lov√° A, et al.",
                title: "Mammary analogue secretory carcinoma: molecular analysis of 25 cases",
                journal: "Am J Surg Pathol. 2015;39(2):234-41",
                year: 2015,
                doi: "10.1097/PAS.0000000000000301",
                pmid: "25229768",
                tags: ["MASC", "ETV6-NTRK3", "molecular", "DOG1"],
                evidence: "cohort"
            },
            {
                id: 6,
                authors: "Williams MD, et al.",
                title: "Differential expression of hormonal and growth factor receptors in salivary duct carcinomas",
                journal: "Am J Surg Pathol. 2007;31(11):1645-52",
                year: 2007,
                doi: "10.1097/PAS.0b013e3180487948",
                pmid: "18059220",
                tags: ["SDC", "AR", "HER2", "IHC"],
                evidence: "cohort"
            },
            {
                id: 7,
                authors: "Seethala RR, Stenman G",
                title: "Update from the 4th Edition WHO: Tumors of the Salivary Gland",
                journal: "Head Neck Pathol. 2017;11(1):55-67",
                year: 2017,
                doi: "10.1007/s12105-017-0795-0",
                pmid: "28247226",
                tags: ["WHO", "classification", "PA", "ACC", "MEC"],
                evidence: "who"
            },
            {
                id: 8,
                authors: "Mitani Y, et al.",
                title: "Novel MYBL1 gene rearrangements with recurrent MYBL1-NFIB fusions in ACC",
                journal: "Genes Chromosomes Cancer. 2011;50(7):559-64",
                year: 2011,
                doi: "10.1002/gcc.20882",
                pmid: "21484928",
                tags: ["ACC", "MYB-NFIB", "MYBL1", "molecular"],
                evidence: "case"
            },
            {
                id: 9,
                authors: "Higgins KE, Cipriani NA",
                title: "Practical Guide to IHC in Salivary Gland Pathology",
                journal: "Semin Diagn Pathol. 2022;39:17-28",
                year: 2022,
                doi: "10.1053/j.semdp.2021.09.002",
                pmid: "34635357",
                tags: ["IHC", "LEF1", "p63", "SMA", "DOG1", "Ki-67"],
                evidence: "cohort"
            },
            {
                id: 10,
                authors: "Sk√°lov√° A, Hyrcza MD, Leivo I",
                title: "Update from the 5th WHO: Tumours of salivary glands",
                journal: "Head Neck Pathol. 2022;16:40-53",
                year: 2022,
                doi: "10.1007/s12105-022-01420-4",
                pmid: "35288841",
                tags: ["WHO", "classification", "grading", "PA", "ACC"],
                evidence: "who"
            },
            {
                id: 11,
                authors: "El-Naggar AK, et al.",
                title: "Adenoid cystic carcinoma: A review of recent advances, molecular targets, and clinical trials",
                journal: "Head Neck. 2020;42(4):772-788",
                year: 2020,
                doi: "10.1002/hed.26073",
                pmid: "31854488",
                tags: ["ACC", "molecular", "therapy", "clinical trials"],
                evidence: "cohort"
            },
            {
                id: 12,
                authors: "Coca-Pelaz A, et al.",
                title: "Mucoepidermoid carcinoma of the salivary glands",
                journal: "Oral Oncol. 2015;51(9):845-52",
                year: 2015,
                doi: "10.1016/j.oraloncology.2015.06.006",
                pmid: "26095097",
                tags: ["MEC", "MAML2", "grading", "prognosis"],
                evidence: "cohort"
            },
            {
                id: 13,
                authors: "Rettig EM, et al.",
                title: "Molecular markers and diagnosis of salivary gland neoplasms",
                journal: "Ann Surg Oncol. 2017;24(12):3616-3623",
                year: 2017,
                doi: "10.1245/s10434-017-6077-1",
                pmid: "28905161",
                tags: ["molecular", "diagnosis", "FISH", "NGS"],
                evidence: "cohort"
            },
            {
                id: 14,
                authors: "Tonon G, et al.",
                title: "t(11;19)(q21;p13) translocation in mucoepidermoid carcinoma creates a novel fusion product",
                journal: "Nature. 2003;424(6950):917-21",
                year: 2003,
                doi: "10.1038/nature01802",
                pmid: "12931188",
                tags: ["MEC", "MAML2", "CRTC1", "molecular"],
                evidence: "case"
            },
            {
                id: 15,
                authors: "Moskaluk CA, et al.",
                title: "Acinic cell carcinomas: molecular profiling and targeted therapy",
                journal: "Mod Pathol. 2019;32(8):1092-1102",
                year: 2019,
                doi: "10.1038/s41379-019-0234-8",
                pmid: "30886328",
                tags: ["acinic", "NR4A3", "molecular", "therapy"],
                evidence: "cohort"
            }
        ];

        // ========== FUNZIONI DI NAVIGAZIONE E PROGRESS ==========
        function updateProgress() {
            const percentage = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        function nextStep() {
            saveData();
            if (validateStep()) {
                currentStep++;
                if (currentStep > totalSteps) {
                    currentStep = totalSteps;
                }
                render();
            }
        }

        function prevStep() {
            saveData();
            currentStep--;
            if (currentStep < 1) {
                currentStep = 1;
            }
            render();
        }

        // ========== VALIDAZIONE ==========
        function validateStep() {
            if (currentStep === 1) {
                const specimenType = document.querySelector('input[name="specimenType"]:checked');
                const gland = document.getElementById('gland')?.value;
                
                if (!specimenType || !gland || gland === '-- Seleziona --') {
                    alert('‚ö†Ô∏è Compila tutti i campi obbligatori:\n- Tipo campione\n- Ghiandola');
                    return false;
                }
            }
            
            if (currentStep === 3) {
                const pattern = document.querySelector('input[name="pattern"]:checked');
                if (!pattern) {
                    alert('‚ö†Ô∏è Seleziona il pattern morfologico predominante');
                    return false;
                }
            }
            
            if (currentStep === 4) {
                const ki67 = document.getElementById('ki67')?.value;
                if (!ki67) {
                    alert('‚ö†Ô∏è Inserisci il valore Ki-67 (campo obbligatorio)');
                    return false;
                }
                const ki67Val = parseFloat(ki67);
                if (ki67Val < 0 || ki67Val > 100) {
                    alert('‚ö†Ô∏è Ki-67 deve essere tra 0 e 100%');
                    return false;
                }
            }
            
            return true;
        }

        // ========== SALVATAGGIO DATI ==========
        function saveData() {
            const specimenType = document.querySelector('input[name="specimenType"]:checked')?.value;
            const gland = document.getElementById('gland')?.value;
            const location = document.getElementById('location')?.value;
            const pni = document.querySelector('input[name="pni"]:checked')?.value;
            const cytology = document.querySelector('input[name="cytology"]:checked')?.value;
            const necrosis = document.querySelector('input[name="necrosis"]:checked')?.value;
            const pattern = document.querySelector('input[name="pattern"]:checked')?.value;
            const solidPercentage = document.getElementById('solidPercentage')?.value;
            const p63 = document.querySelector('input[name="p63"]:checked')?.value;
            const sma = document.querySelector('input[name="sma"]:checked')?.value;
            const calponin = document.querySelector('input[name="calponin"]:checked')?.value;
            const ck7 = document.querySelector('input[name="ck7"]:checked')?.value;
            const s100 = document.querySelector('input[name="s100"]:checked')?.value;
            const dog1 = document.querySelector('input[name="dog1"]:checked')?.value;
            const ki67 = document.getElementById('ki67')?.value;
            
            const discriminantMarkers = {};
            for (let i = 0; i < 10; i++) {
                const marker = document.querySelector(`input[name="m${i}"]:checked`)?.value;
                if (marker) discriminantMarkers[`m${i}`] = marker;
            }
            
            const myb = document.querySelector('input[name="myb"]:checked')?.value;
            const nr4a3 = document.querySelector('input[name="nr4a3"]:checked')?.value;
            const etv6 = document.querySelector('input[name="etv6"]:checked')?.value;
            const maml2 = document.querySelector('input[name="maml2"]:checked')?.value;
            const clinicalSuspicion = document.getElementById('clinicalSuspicion')?.value;
            const clinicalNotes = document.getElementById('clinicalNotes')?.value;
            
            if (specimenType) formData.specimenType = specimenType;
            if (gland) formData.gland = gland;
            if (location) formData.location = location;
            if (pni) formData.pni = pni;
            if (cytology) formData.cytology = cytology;
            if (necrosis) formData.necrosis = necrosis;
            if (pattern) formData.pattern = pattern;
            if (solidPercentage) formData.solidPercentage = solidPercentage;
            if (p63) formData.p63 = p63;
            if (sma) formData.sma = sma;
            if (calponin) formData.calponin = calponin;
            if (ck7) formData.ck7 = ck7;
            if (s100) formData.s100 = s100;
            if (dog1) formData.dog1 = dog1;
            if (ki67) formData.ki67 = ki67;
            if (Object.keys(discriminantMarkers).length > 0) {
                formData.discriminantMarkers = discriminantMarkers;
            }
            if (myb) formData.myb = myb;
            if (nr4a3) formData.nr4a3 = nr4a3;
            if (etv6) formData.etv6 = etv6;
            if (maml2) formData.maml2 = maml2;
            if (clinicalSuspicion) formData.clinicalSuspicion = clinicalSuspicion;
            if (clinicalNotes) formData.clinicalNotes = clinicalNotes;
        }

        // ========== CALCOLO RISULTATI ==========
        function computeResults() {
            let paScore = 0;
            let accScore = 0;
            let details = {
                pa: [],
                acc: []
            };
            
            if (formData.pattern === 'pleomorphic') {
                paScore += 3;
                details.pa.push('Pattern pleomorfo caratteristico');
            }
            if (formData.pattern === 'basaloid' || formData.pattern === 'cribriform') {
                accScore += 4;
                details.acc.push(`Pattern ${formData.pattern === 'cribriform' ? 'cribriforme' : 'basaloide'}`);
            }
            
            const p63 = formData.p63;
            const sma = formData.sma;
            const calponin = formData.calponin;
            
            const myoIntact = (p63 === 'pos' || p63 === 'focal') && 
                             (sma === 'pos' || sma === 'focal') && 
                             (calponin === 'pos' || calponin === 'focal');
            const myoLost = (p63 === 'neg' && sma === 'neg') || 
                           (p63 === 'nd' && sma === 'nd');
            
            if (myoIntact) {
                paScore += 3;
                details.pa.push('Mantello mioepiteliale conservato');
            }
            if (myoLost) {
                accScore += 4;
                details.acc.push('Perdita mantello mioepiteliale');
            }
            
            const ki67 = parseFloat(formData.ki67) || 0;
            if (ki67 <= 10) {
                paScore += 2;
                details.pa.push(`Ki-67 basso (${ki67}%)`);
            }
            if (ki67 > 15) {
                accScore += 3;
                details.acc.push(`Ki-67 elevato (${ki67}%)`);
            }
            if (ki67 >= 25) {
                accScore += 2;
                details.acc.push('Ki-67 molto alto (>25%)');
            }
            
            if (formData.pni === 'no') {
                paScore += 3;
                details.pa.push('Assenza infiltrazione perineurale');
            }
            if (formData.pni === 'yes') {
                accScore += 5;
                details.acc.push('‚ö†Ô∏è INFILTRAZIONE PERINEURALE PRESENTE');
            }
            
            const lef1 = formData.discriminantMarkers?.m4;
            if (lef1 === 'pos') {
                paScore += 4;
                details.pa.push('LEF1 positivo (esclude ACC)');
            }
            if (lef1 === 'neg') {
                accScore += 3;
                details.acc.push('LEF1 negativo');
            }
            
            if (formData.myb === 'pos') {
                accScore += 4;
                details.acc.push('MYB-NFIB positivo');
            }
            if (formData.myb === 'neg') {
                paScore += 1;
                details.pa.push('MYB-NFIB negativo');
            }
            
            if (formData.cytology === 'low') {
                paScore += 1;
                details.pa.push('Bassa atipia citologica');
            }
            if (formData.cytology === 'high') {
                accScore += 2;
                details.acc.push('Alta atipia citologica');
            }
            
            if (formData.necrosis === 'no') {
                paScore += 1;
                details.pa.push('Assenza di necrosi');
            }
            if (formData.necrosis === 'yes') {
                accScore += 3;
                details.acc.push('Presenza di necrosi');
            }
            
            const solidPct = parseFloat(formData.solidPercentage) || 0;
            if (solidPct > 30 && formData.pattern === 'basaloid') {
                accScore += 2;
                details.acc.push(`Componente solida >30% (${solidPct}%)`);
            }
            
            let results = [];
            const scoreDiff = Math.abs(paScore - accScore);
            const isBorderline = scoreDiff < 3;
            
            if (isBorderline) {
                results.push({
                    diagnosis: 'DIAGNOSI DIFFERENZIALE NON CONCLUSIVA',
                    pattern: 'Necessari ulteriori approfondimenti',
                    score: Math.max(paScore, accScore),
                    confidence: 'borderline',
                    rationale: [
                        `Score PA: ${paScore} vs ACC: ${accScore} (differenza <3 punti)`,
                        '‚ö†Ô∏è Risultato borderline - considerare:',
                        '‚Ä¢ Molecolare aggiuntiva (FISH MYB, PLAG1)',
                        '‚Ä¢ Second opinion da centro di riferimento',
                        '‚Ä¢ Ricampionamento se biopsia limitata',
                        '‚Ä¢ Correlazione clinico-radiologica approfondita'
                    ],
                    details: []
                });
            }
            
            if (paScore >= accScore) {
                results.push({
                    diagnosis: 'Adenoma Pleomorfo',
                    pattern: 'Pattern compatibile con adenoma pleomorfo',
                    behavior: 'Comportamento tipicamente benigno',
                    score: paScore,
                    confidence: isBorderline ? 'moderate' : (scoreDiff >= 5 ? 'high' : 'moderate'),
                    rationale: details.pa,
                    details: details.pa
                });
            }
            
            if (accScore >= paScore) {
                results.push({
                    diagnosis: 'Carcinoma Adenoidocistico',
                    pattern: 'Pattern compatibile con carcinoma adenoidocistico',
                    behavior: 'Comportamento maligno',
                    score: accScore,
                    confidence: isBorderline ? 'moderate' : (scoreDiff >= 5 ? 'high' : 'moderate'),
                    rationale: details.acc,
                    details: details.acc
                });
            }
            
            if (!isBorderline) {
                if (paScore > accScore) {
                    results.push({
                        diagnosis: 'Carcinoma Adenoidocistico',
                        pattern: 'Meno probabile in base ai dati',
                        behavior: 'Comportamento maligno',
                        score: accScore,
                        confidence: 'low',
                        rationale: ['Score insufficiente per ACC'],
                        details: details.acc
                    });
                } else if (accScore > paScore) {
                    results.push({
                        diagnosis: 'Adenoma Pleomorfo',
                        pattern: 'Meno probabile in base ai dati',
                        behavior: 'Comportamento tipicamente benigno',
                        score: paScore,
                        confidence: 'low',
                        rationale: ['Score insufficiente per PA'],
                        details: details.pa
                    });
                }
            }
            
            if (formData.clinicalNotes && formData.clinicalNotes.toLowerCase().includes('trasform')) {
                results.push({
                    diagnosis: 'Carcinoma ex-Adenoma Pleomorfo',
                    pattern: 'Da considerare se lunga storia clinica',
                    behavior: 'Trasformazione maligna',
                    score: 0,
                    confidence: 'evaluate',
                    rationale: ['Segnalato nelle note cliniche', 'Valutare storia clinica'],
                    details: []
                });
            }
            
            return results.sort((a, b) => b.score - a.score);
        }

        // ========== BIBLIOGRAFIA INTERATTIVA ==========
        function toggleBiblio() {
            const sidebar = document.getElementById('biblioSidebar');
            sidebar.classList.toggle('open');
            
            if (sidebar.classList.contains('open')) {
                updateBiblioFilters();
            }
        }

        function getActiveTags() {
            const tags = new Set();
            
            if (formData.pattern) {
                const patternMap = {
                    'basaloid': ['ACC', 'basaloid'],
                    'cribriform': ['ACC', 'cribriform'],
                    'acinic': ['acinic', 'DOG1', 'NR4A3'],
                    'oncocytic': ['oncocytic', 'DOG1'],
                    'mucoepidermoid': ['MEC', 'MAML2'],
                    'pleomorphic': ['PA', 'LEF1', 'PLAG1'],
                    'ductal': ['SDC', 'AR', 'HER2'],
                    'clear_cell': ['clear cell']
                };
                const mapped = patternMap[formData.pattern] || [];
                mapped.forEach(t => tags.add(t));
            }
            
            if (formData.myb === 'pos') tags.add('MYB-NFIB');
            if (formData.etv6 === 'pos') tags.add('ETV6-NTRK3');
            if (formData.maml2 === 'pos') tags.add('MAML2');
            if (formData.nr4a3 === 'pos') tags.add('NR4A3');
            if (formData.pni === 'yes') tags.add('PNI');
            if (formData.p63) tags.add('p63');
            if (formData.ki67) tags.add('Ki-67');
            if (formData.dog1) tags.add('DOG1');
            
            tags.add('WHO');
            tags.add('classification');
            
            return Array.from(tags);
        }

        function updateBiblioFilters() {
            const activeTags = getActiveTags();
            const filterDiv = document.getElementById('activeFilters');
            const refsDiv = document.getElementById('biblioRefs');
            
            if (activeTags.length === 0) {
                filterDiv.innerHTML = '<span>Nessun filtro (mostra tutto)</span>';
            } else {
                filterDiv.innerHTML = activeTags.map(tag => 
                    `<span>${tag}</span>`
                ).join('');
            }
            
            const filtered = references.filter(ref => {
                if (activeTags.length === 0) return true;
                return activeTags.some(tag => 
                    ref.tags.some(refTag => 
                        refTag.toLowerCase().includes(tag.toLowerCase()) ||
                        tag.toLowerCase().includes(refTag.toLowerCase())
                    )
                );
            });
            
            if (filtered.length === 0) {
                refsDiv.innerHTML = '<div class="info-box">Nessuna referenza trovata per i criteri selezionati</div>';
            } else {
                refsDiv.innerHTML = filtered.map(ref => {
                    const evidenceBadge = ref.evidence === 'who' ? 
                        '<span class="evidence-badge evidence-who">üü¢ WHO</span>' :
                        ref.evidence === 'cohort' ?
                        '<span class="evidence-badge evidence-cohort">üü° Cohort</span>' :
                        '<span class="evidence-badge evidence-case">üîµ Case Series</span>';
                    
                    let links = '';
                    if (ref.doi) links += `<a href="https://doi.org/${ref.doi}" target="_blank">DOI</a>`;
                    if (ref.pmid) links += `<a href="https://pubmed.ncbi.nlm.nih.gov/${ref.pmid}/" target="_blank">PubMed</a>`;
                    if (ref.iarc) links += `<a href="${ref.iarc}" target="_blank">IARC</a>`;
                    
                    return `
                        <div class="ref-item">
                            ${evidenceBadge}
                            <div class="authors">${ref.authors}</div>
                            <div class="title">${ref.title}</div>
                            <div class="journal">${ref.journal}</div>
                            <div class="tags">
                                ${ref.tags.map(tag => `<span class="ref-tag">${tag}</span>`).join('')}
                            </div>
                            ${links ? `<div class="ref-links">${links}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function normalizeForMatching(text) {
            return text.toLowerCase().trim();
        }

        function findTumorMatch(suspicion, diagnosis) {
            const suspLower = normalizeForMatching(suspicion);
            const diagLower = normalizeForMatching(diagnosis);
            
            if (diagLower.includes(suspLower) || suspLower.includes(diagLower)) {
                return true;
            }
            
            for (const [mainName, synonyms] of Object.entries(tumorSynonyms)) {
                const suspInSyn = synonyms.some(syn => 
                    normalizeForMatching(syn).includes(suspLower) || 
                    suspLower.includes(normalizeForMatching(syn))
                );
                const diagInSyn = synonyms.some(syn => 
                    normalizeForMatching(syn).includes(diagLower) || 
                    diagLower.includes(normalizeForMatching(syn))
                );
                
                if (suspInSyn && diagInSyn) {
                    return true;
                }
            }
            
            return false;
        }

        function updateLocationOptions() {
            const gland = document.getElementById('gland')?.value;
            const select = document.getElementById('location');
            if (!select) return;
            
            const options = {
                parotid: ['-- Seleziona --', 'Lobo superficiale', 'Lobo profondo', 'Coda parotide', 'Polo inferiore'],
                submandibular: ['-- Seleziona --', 'Corpo principale', 'Ilo ghiandolare', 'Polo anteriore'],
                sublingual: ['-- Seleziona --', 'Corpo principale', 'Porzione ventrale', 'Porzione laterale'],
                minor: ['-- Seleziona --', 'Palato duro', 'Palato molle', 'Labbro superiore', 'Labbro inferiore', 'Guancia', 'Lingua', 'Pavimento orale']
            };
            
            const opts = options[gland] || ['-- Seleziona prima la ghiandola --'];
            select.innerHTML = opts.map(opt => `<option value="${opt}">${opt}</option>`).join('');
        }

        function generateTextReport() {
            const results = computeResults();
            const date = new Date().toLocaleDateString('it-IT');
            
            let report = `REPORT DIAGNOSTICO - NEOPLASIA GHIANDOLE SALIVARI\n`;
            report += `Data: ${date}\n\n`;
            report += `DATI CLINICI\n`;
            report += `Campione: ${formData.specimenType || 'N/D'}\n`;
            report += `Ghiandola: ${formData.gland || 'N/D'}\n`;
            report += `Localizzazione: ${formData.location || 'N/D'}\n\n`;
            
            report += `PARAMETRI MORFOLOGICI\n`;
            report += `Pattern: ${formData.pattern || 'N/D'}\n`;
            report += `Ki-67: ${formData.ki67 || 'N/D'}%\n`;
            report += `Infiltrazione perineurale: ${formData.pni || 'N/D'}\n`;
            report += `Atipia citologica: ${formData.cytology || 'N/D'}\n`;
            report += `Necrosi: ${formData.necrosis || 'N/D'}\n\n`;
            
            report += `DIAGNOSI DIFFERENZIALE\n`;
            results.forEach((r, i) => {
                report += `${i + 1}. ${r.pattern}\n`;
                report += `   Confidenza: ${r.confidence}\n`;
                report += `   Score: ${r.score}/30\n`;
                if (r.behavior) {
                    report += `   Comportamento: ${r.behavior}\n`;
                }
                report += `\n`;
            });
            
            report += `\nNOTE CLINICHE\n`;
            report += formData.clinicalNotes || 'Nessuna nota aggiuntiva';
            report += `\n\nDISCLAIMER: Strumento di supporto diagnostico. `;
            report += `La diagnosi finale richiede integrazione con morfologia completa, IHC e correlazione clinica.\n`;
            
            return report;
        }

        function downloadTextReport() {
            const report = generateTextReport();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `salivary_report_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // ========== RENDERING ==========
        function render() {
            let html = '';
            
            if (currentStep === 1) {
                html = `
                    <div class="step active">
                        <h3>Step 1/8: Contesto Clinico</h3>
                        
                        <div class="form-group">
                            <label>Tipo di campione: <span style="color: red;">*</span></label>
                            <div class="radio-group" style="flex-direction: column;">
                                <label>
                                    <input type="radio" name="specimenType" value="trucut" 
                                           ${formData.specimenType === 'trucut' ? 'checked' : ''}>
                                    <b>Trucut/Core biopsy</b> - Margini non valutabili
                                </label>
                                <label>
                                    <input type="radio" name="specimenType" value="surgical" 
                                           ${formData.specimenType === 'surgical' ? 'checked' : ''}>
                                    <b>Pezzo operatorio</b> - Valutazione completa
                                </label>
                                <label>
                                    <input type="radio" name="specimenType" value="fnab" 
                                           ${formData.specimenType === 'fnab' ? 'checked' : ''}>
                                    <b>FNAB</b> - Citologia
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Ghiandola interessata: <span style="color: red;">*</span></label>
                            <select id="gland" onchange="updateLocationOptions()">
                                <option value="">-- Seleziona --</option>
                                <option value="parotid" ${formData.gland === 'parotid' ? 'selected' : ''}>
                                    Parotide (20% probabilit√† malignit√†)
                                </option>
                                <option value="submandibular" ${formData.gland === 'submandibular' ? 'selected' : ''}>
                                    Sottomandibolare (45-50% malignit√†)
                                </option>
                                <option value="sublingual" ${formData.gland === 'sublingual' ? 'selected' : ''}>
                                    Sottolinguale (50-75% malignit√†)
                                </option>
                                <option value="minor" ${formData.gland === 'minor' ? 'selected' : ''}>
                                    Ghiandole minori (50-75% malignit√†)
                                </option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Localizzazione intraghiandolare:</label>
                            <select id="location">
                                <option>-- Seleziona prima la ghiandola --</option>
                            </select>
                        </div>
                        
                        <div class="info-box">
                            <strong>Nota:</strong> La sede anatomica influenza la probabilit√† pre-test di malignit√†
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" disabled>‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
                
            } else if (currentStep === 2) {
                html = `
                    <div class="step active">
                        <h3>Step 2/8: Criteri di Malignit√†</h3>
                        
                        <div class="form-group">
                            <label>Infiltrazione perineurale (PNI):</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="pni" value="no" 
                                           ${formData.pni === 'no' ? 'checked' : ''}>
                                    Assente
                                </label>
                                <label>
                                    <input type="radio" name="pni" value="yes" 
                                           ${formData.pni === 'yes' ? 'checked' : ''}>
                                    Presente ‚ö†Ô∏è
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Atipia citologica:</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="cytology" value="low" 
                                           ${formData.cytology === 'low' ? 'checked' : ''}>
                                    Bassa/assente
                                </label>
                                <label>
                                    <input type="radio" name="cytology" value="high" 
                                           ${formData.cytology === 'high' ? 'checked' : ''}>
                                    Alta/marcata
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Necrosi tumorale:</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="necrosis" value="no" 
                                           ${formData.necrosis === 'no' ? 'checked' : ''}>
                                    Assente
                                </label>
                                <label>
                                    <input type="radio" name="necrosis" value="yes" 
                                           ${formData.necrosis === 'yes' ? 'checked' : ''}>
                                    Presente
                                </label>
                            </div>
                        </div>
                        
                        <div class="critical-box">
                            <strong>‚ö†Ô∏è Importante:</strong> L'infiltrazione perineurale √® un forte predittore di malignit√†, 
                            particolarmente nell'adenoidocistico
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
                
            } else if (currentStep === 3) {
                html = `
                    <div class="step active">
                        <h3>Step 3/8: Pattern Architetturale Predominante</h3>
                        
                        <div class="form-group">
                            <label>Pattern morfologico principale: <span style="color: red;">*</span></label>
                            <div class="radio-group" style="flex-direction: column;">
                                <label>
                                    <input type="radio" name="pattern" value="basaloid" 
                                           ${formData.pattern === 'basaloid' ? 'checked' : ''}>
                                    <b>Basaloide</b> - Cellule basali uniformi, nuclei ipercromici
                                </label>
                                <label>
                                    <input type="radio" name="pattern" value="cribriform" 
                                           ${formData.pattern === 'cribriform' ? 'checked' : ''}>
                                    <b>Cribriforme</b> - Pseudocisti con materiale ialino PAS+
                                </label>
                                <label>
                                    <input type="radio" name="pattern" value="acinic" 
                                           ${formData.pattern === 'acinic' ? 'checked' : ''}>
                                    <b>Acinare</b> - Cellule sierose con granuli zimogeni
                                </label>
                                <label>
                                    <input type="radio" name="pattern" value="oncocytic" 
                                           ${formData.pattern === 'oncocytic' ? 'checked' : ''}>
                                    <b>Oncocitario</b> - Cellule eosinofile ricche di mitocondri
                                </label>
                                <label>
                                    <input type="radio" name="pattern" value="mucoepidermoid" 
                                           ${formData.pattern === 'mucoepidermoid' ? 'checked' : ''}>
                                    <b>Mucoepidermoide</b> - Mix cellule mucose/intermedie/squamose
                                </label>
                                <label>
                                    <input type="radio" name="pattern" value="pleomorphic" 
                                           ${formData.pattern === 'pleomorphic' ? 'checked' : ''}>
                                    <b>Pleomorfo</b> - Bifasico con stroma mixoide/condroide
                                </label>
                                <label>
                                    <input type="radio" name="pattern" value="clear_cell" 
                                           ${formData.pattern === 'clear_cell' ? 'checked' : ''}>
                                    <b>Cellule chiare</b> - Citoplasma otticamente vuoto
                                </label>
                                <label>
                                    <input type="radio" name="pattern" value="squamous" 
                                           ${formData.pattern === 'squamous' ? 'checked' : ''}>
                                    <b>Squamoso</b> - Differenziazione squamosa evidente
                                </label>
                                <label>
                                    <input type="radio" name="pattern" value="ductal" 
                                           ${formData.pattern === 'ductal' ? 'checked' : ''}>
                                    <b>Duttale</b> - Strutture duttali, aspetto apocrino
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Percentuale componente solida (se applicabile):</label>
                            <input type="number" id="solidPercentage" min="0" max="100" 
                                   value="${formData.solidPercentage || ''}"
                                   placeholder="0-100%">
                            <small style="color: #666;">
                                Nel pattern basaloide/cribriforme: >30% = grado III (prognosi peggiore)
                            </small>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
                
            } else if (currentStep === 4) {
                html = `
                    <div class="step active">
                        <h3>Step 4/8: Immunoistochimica di Base</h3>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>Marcatore</th>
                                    <th>Positivo</th>
                                    <th>Negativo</th>
                                    <th>Focale</th>
                                    <th>Non eseguito</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><b>p63</b> (mioepiteliale)</td>
                                    <td><input type="radio" name="p63" value="pos" ${formData.p63 === 'pos' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="p63" value="neg" ${formData.p63 === 'neg' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="p63" value="focal" ${formData.p63 === 'focal' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="p63" value="nd" ${formData.p63 === 'nd' ? 'checked' : ''}></td>
                                </tr>
                                <tr>
                                    <td><b>SMA</b> (mioepiteliale)</td>
                                    <td><input type="radio" name="sma" value="pos" ${formData.sma === 'pos' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="sma" value="neg" ${formData.sma === 'neg' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="sma" value="focal" ${formData.sma === 'focal' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="sma" value="nd" ${formData.sma === 'nd' ? 'checked' : ''}></td>
                                </tr>
                                <tr>
                                    <td><b>Calponina</b> (mioepiteliale)</td>
                                    <td><input type="radio" name="calponin" value="pos" ${formData.calponin === 'pos' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="calponin" value="neg" ${formData.calponin === 'neg' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="calponin" value="focal" ${formData.calponin === 'focal' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="calponin" value="nd" ${formData.calponin === 'nd' ? 'checked' : ''}></td>
                                </tr>
                                <tr>
                                    <td><b>CK7</b></td>
                                    <td><input type="radio" name="ck7" value="pos" ${formData.ck7 === 'pos' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="ck7" value="neg" ${formData.ck7 === 'neg' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="ck7" value="focal" ${formData.ck7 === 'focal' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="ck7" value="nd" ${formData.ck7 === 'nd' ? 'checked' : ''}></td>
                                </tr>
                                <tr>
                                    <td><b>S100</b></td>
                                    <td><input type="radio" name="s100" value="pos" ${formData.s100 === 'pos' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="s100" value="neg" ${formData.s100 === 'neg' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="s100" value="focal" ${formData.s100 === 'focal' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="s100" value="nd" ${formData.s100 === 'nd' ? 'checked' : ''}></td>
                                </tr>
                                <tr>
                                    <td><b>DOG1</b></td>
                                    <td><input type="radio" name="dog1" value="pos" ${formData.dog1 === 'pos' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="dog1" value="neg" ${formData.dog1 === 'neg' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="dog1" value="focal" ${formData.dog1 === 'focal' ? 'checked' : ''}></td>
                                    <td><input type="radio" name="dog1" value="nd" ${formData.dog1 === 'nd' ? 'checked' : ''}></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label><b>Ki-67 Index (%):</b> <span style="color: red;">*</span></label>
                            <input type="number" id="ki67" min="0" max="100" step="0.1" 
                                   value="${formData.ki67 || ''}"
                                   placeholder="0-100%">
                        </div>
                        
                        <div class="info-box">
                            <strong>Cut-off Ki-67:</strong><br>
                            ‚Ä¢ ‚â§10% = suggestivo di benignit√†<br>
                            ‚Ä¢ 11-15% = borderline<br>
                            ‚Ä¢ >15% = suggestivo di malignit√†<br>
                            ‚Ä¢ >25% = prognosi sfavorevole
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
                
            } else if (currentStep === 5) {
                const selectedPattern = formData.pattern;
                const patternInfo = patterns[selectedPattern] || {};
                const markers = patternInfo.markers || [];
                
                if (!selectedPattern || markers.length === 0) {
                    html = `
                        <div class="step active">
                            <h3>Step 5/8: IHC Discriminanti Pattern-Specifici</h3>
                            <div class="critical-box">
                                ‚ö†Ô∏è Nessun pattern selezionato o marcatori non disponibili.<br>
                                Torna allo Step 3 per selezionare il pattern morfologico.
                            </div>
                            <div class="buttons">
                                <button class="btn-secondary" onclick="prevStep()">‚Üê Torna a Step 3</button>
                                <button class="btn-primary" onclick="nextStep()">Salta ‚Üí</button>
                            </div>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="step active">
                            <h3>Step 5/8: IHC Discriminanti per Pattern ${patternInfo.name}</h3>
                            
                            <div class="info-box">
                                <strong>Pattern selezionato:</strong> ${patternInfo.name}<br>
                                <strong>Marcatori discriminanti:</strong> ${markers.length} disponibili
                            </div>
                            
                            <table>
                                <thead>
                                    <tr>
                                        <th>Marcatore Discriminante</th>
                                        <th>Positivo</th>
                                        <th>Negativo</th>
                                        <th>Focale</th>
                                        <th>Non eseguito</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${markers.map((marker, i) => {
                                        const savedValue = formData.discriminantMarkers?.[`m${i}`] || '';
                                        return `
                                            <tr>
                                                <td><b>${marker}</b></td>
                                                <td><input type="radio" name="m${i}" value="pos" ${savedValue === 'pos' ? 'checked' : ''}></td>
                                                <td><input type="radio" name="m${i}" value="neg" ${savedValue === 'neg' ? 'checked' : ''}></td>
                                                <td><input type="radio" name="m${i}" value="focal" ${savedValue === 'focal' ? 'checked' : ''}></td>
                                                <td><input type="radio" name="m${i}" value="nd" ${savedValue === 'nd' ? 'checked' : ''}></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                            
                            <div class="buttons">
                                <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                                <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                            </div>
                        </div>
                    `;
                }
                
            } else if (currentStep === 6) {
                html = `
                    <div class="step active">
                        <h3>Step 6/8: Studi Molecolari (FISH/PCR/NGS)</h3>
                        
                        <div class="critical-box">
                            <strong>‚ö†Ô∏è Importante:</strong> Risultato negativo NON esclude la diagnosi. 
                            La morfologia e IHC rimangono fondamentali.
                        </div>
                        
                        <div class="form-group">
                            <label><b>MYB-NFIB</b> (Adenoidocistico):</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="myb" value="pos" 
                                           ${formData.myb === 'pos' ? 'checked' : ''}>
                                    Positivo (~80% ACC)
                                </label>
                                <label>
                                    <input type="radio" name="myb" value="neg" 
                                           ${formData.myb === 'neg' ? 'checked' : ''}>
                                    Negativo
                                </label>
                                <label>
                                    <input type="radio" name="myb" value="nd" 
                                           ${formData.myb === 'nd' ? 'checked' : ''}>
                                    Non eseguito
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label><b>NR4A3</b> (Carcinoma Acinare):</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="nr4a3" value="pos" 
                                           ${formData.nr4a3 === 'pos' ? 'checked' : ''}>
                                    Positivo (specifico)
                                </label>
                                <label>
                                    <input type="radio" name="nr4a3" value="neg" 
                                           ${formData.nr4a3 === 'neg' ? 'checked' : ''}>
                                    Negativo
                                </label>
                                <label>
                                    <input type="radio" name="nr4a3" value="nd" 
                                           ${formData.nr4a3 === 'nd' ? 'checked' : ''}>
                                    Non eseguito
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label><b>ETV6-NTRK3</b> (MASC):</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="etv6" value="pos" 
                                           ${formData.etv6 === 'pos' ? 'checked' : ''}>
                                    Positivo (patognomonico MASC)
                                </label>
                                <label>
                                    <input type="radio" name="etv6" value="neg" 
                                           ${formData.etv6 === 'neg' ? 'checked' : ''}>
                                    Negativo
                                </label>
                                <label>
                                    <input type="radio" name="etv6" value="nd" 
                                           ${formData.etv6 === 'nd' ? 'checked' : ''}>
                                    Non eseguito
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label><b>MAML2</b> (Mucoepidermoide):</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="maml2" value="pos" 
                                           ${formData.maml2 === 'pos' ? 'checked' : ''}>
                                    Positivo (50-70% MEC)
                                </label>
                                <label>
                                    <input type="radio" name="maml2" value="neg" 
                                           ${formData.maml2 === 'neg' ? 'checked' : ''}>
                                    Negativo
                                </label>
                                <label>
                                    <input type="radio" name="maml2" value="nd" 
                                           ${formData.maml2 === 'nd' ? 'checked' : ''}>
                                    Non eseguito
                                </label>
                            </div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Avanti ‚Üí</button>
                        </div>
                    </div>
                `;
                
            } else if (currentStep === 7) {
                html = `
                    <div class="step active">
                        <h3>Step 7/8: Informazioni Cliniche (Opzionale)</h3>
                        
                        <div class="form-group">
                            <label>Sospetto clinico iniziale:</label>
                            <input type="text" id="clinicalSuspicion" 
                                   value="${formData.clinicalSuspicion || ''}"
                                   placeholder="Es: Adenoma pleomorfo, Carcinoma adenoidocistico...">
                        </div>
                        
                        <div class="form-group">
                            <label>Note cliniche e red flags:</label>
                            <textarea id="clinicalNotes" 
                                      placeholder="Inserisci note rilevanti, storia clinica, sospetta trasformazione maligna, etc.">${formData.clinicalNotes || ''}</textarea>
                        </div>
                        
                        <div class="info-box">
                            Le note cliniche possono includere informazioni su:
                            ‚Ä¢ Durata della lesione
                            ‚Ä¢ Crescita rapida o lenta
                            ‚Ä¢ Sintomi (dolore, paralisi facciale)
                            ‚Ä¢ Precedenti biopsie
                            ‚Ä¢ Sospetta trasformazione maligna
                        </div>
                        
                        <div class="buttons">
                            <button class="btn-secondary" onclick="prevStep()">‚Üê Indietro</button>
                            <button class="btn-primary" onclick="nextStep()">Visualizza Risultati ‚Üí</button>
                        </div>
                    </div>
                `;
                
            } else if (currentStep === 8) {
                saveData();
                const results = computeResults();
                const suspicion = formData.clinicalSuspicion || '';
                
                let concordanceHTML = '';
                if (suspicion) {
                    let matchFound = false;
                    let matchIndex = -1;
                    
                    results.forEach((r, idx) => {
                        if (findTumorMatch(suspicion, r.diagnosis)) {
                            matchFound = true;
                            matchIndex = idx + 1;
                        }
                    });
                    
                    if (matchFound && matchIndex === 1) {
                        concordanceHTML = `
                            <div class="success-box">
                                <strong>‚úÖ CONCORDANZA CLINICO-PATOLOGICA</strong><br>
                                Sospetto clinico: <strong>"${suspicion}"</strong><br>
                                Prima diagnosi differenziale: <strong>"${results[0].diagnosis}"</strong><br>
                                Eccellente correlazione tra sospetto clinico e dati morfologici/IHC
                            </div>
                        `;
                    } else if (matchFound && matchIndex <= 3) {
                        concordanceHTML = `
                            <div class="warning-box">
                                <strong>‚ö†Ô∏è PARZIALE CONCORDANZA</strong><br>
                                Sospetto clinico: <strong>"${suspicion}"</strong> (posizione #${matchIndex})<br>
                                Diagnosi pi√π probabile: <strong>"${results[0].diagnosis}"</strong><br>
                                Il sospetto clinico rimane nella differenziale ma non √® la prima ipotesi
                            </div>
                        `;
                    } else if (matchFound) {
                        concordanceHTML = `
                            <div class="critical-box">
                                <strong>‚ùå DISCORDANZA CLINICO-PATOLOGICA</strong><br>
                                Sospetto clinico: <strong>"${suspicion}"</strong> (bassa probabilit√†)<br>
                                Diagnosi pi√π probabile: <strong>"${results[0].diagnosis}"</strong><br>
                                I dati morfologici e IHC non supportano il sospetto clinico iniziale
                            </div>
                        `;
                    } else {
                        concordanceHTML = `
                            <div class="critical-box">
                                <strong>‚ö†Ô∏è SOSPETTO NON RICONOSCIUTO</strong><br>
                                Il sospetto clinico "${suspicion}" non corrisponde alle diagnosi considerate.<br>
                                Valutare se si tratta di entit√† rara o terminologia non standard.
                            </div>
                        `;
                    }
                }
                
                let borderlineWarning = '';
                if (results[0].confidence === 'borderline') {
                    borderlineWarning = `
                        <div class="critical-box">
                            <strong>‚ö†Ô∏è ATTENZIONE: RISULTATO BORDERLINE</strong><br>
                            La differenza di score tra le diagnosi principali √® minima.<br>
                            <strong>Raccomandazioni:</strong><br>
                            ‚Ä¢ Considerare second opinion da centro di riferimento<br>
                            ‚Ä¢ Eseguire molecolare aggiuntiva (FISH MYB, PLAG1)<br>
                            ‚Ä¢ Ricampionamento se biopsia limitata<br>
                            ‚Ä¢ Stretta correlazione clinico-radiologica
                        </div>
                    `;
                }
                
                html = `
                    <div class="step active">
                        <h3>Step 8/8: Diagnosi Differenziale</h3>
                        
                        ${borderlineWarning}
                        ${concordanceHTML}
                        
                        <div class="report-section">
                            <h4>Risultati Differenziale (click per dettagli)</h4>
                            ${results.map((r, i) => `
                                <div class="diagnosis-rank ${r.confidence}" 
                                     onclick="this.classList.toggle('expanded')">
                                    <div>
                                        <strong>${i + 1}. ${r.pattern}</strong>
                                        <span style="float: right;">
                                            Confidenza: ${r.confidence.toUpperCase()} 
                                            (Score: ${r.score}/30)
                                        </span>
                                    </div>
                                    ${r.behavior ? `<div style="margin-top: 5px; font-size: 12px;">${r.behavior}</div>` : ''}
                                    <div class="rationale">
                                        <strong>Criteri supportivi:</strong><br>
                                        ${r.rationale.map(item => `‚Ä¢ ${item}`).join('<br>')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="report-section">
                            <h4>Riepilogo Dati Inseriti</h4>
                            <table style="font-size: 12px;">
                                <tr><td><strong>Ghiandola:</strong></td><td>${formData.gland || 'N/D'}</td></tr>
                                <tr><td><strong>Pattern:</strong></td><td>${formData.pattern || 'N/D'}</td></tr>
                                <tr><td><strong>Ki-67:</strong></td><td>${formData.ki67 || 'N/D'}%</td></tr>
                                <tr><td><strong>PNI:</strong></td><td>${formData.pni || 'N/D'}</td></tr>
                                <tr><td><strong>Necrosi:</strong></td><td>${formData.necrosis || 'N/D'}</td></tr>
                            </table>
                        </div>
                        
                        ${formData.clinicalNotes ? `
                            <div class="report-section">
                                <h4>Note Cliniche</h4>
                                <p style="font-size: 13px;">${formData.clinicalNotes}</p>
                            </div>
                        ` : ''}
                        
                        <div class="warning-box">
                            <strong>Interpretazione:</strong> I risultati devono essere sempre correlati con:
                            morfologia completa HE, pannello IHC completo, dati clinici e imaging.
                            Questo strumento fornisce solo un orientamento probabilistico.
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button class="btn-primary" onclick="downloadTextReport()" style="margin-right: 10px;">
                                üìÑ Scarica Report TXT
                            </button>
                            <button class="btn-secondary" onclick="if(confirm('Iniziare nuovo caso?')) location.reload();">
                                ‚Üª Nuovo Caso
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('mainContent').innerHTML = html;
            updateProgress();
            
            if (currentStep === 1 && formData.gland) {
                setTimeout(() => updateLocationOptions(), 100);
            }
            
            // Auto-update bibliografia quando cambio step
            if (document.getElementById('biblioSidebar').classList.contains('open')) {
                updateBiblioFilters();
            }
        }

        // ========== INIZIALIZZAZIONE ==========
        window.onload = function() {
            render();
        };
    </script>
</body>
</html>
